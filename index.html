<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>天理劫：兴贤书院谜案 - 沉浸式解谜体验</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'paper': '#fbf8f0', // 仿古纸张色
                        'ink': '#2c3e50', // 墨黑色
                        'wood-dark': '#4b3b3b', // 深木色背景
                        'accent-red': '#a83a3a', // 印章红
                    },
                    fontFamily: {
                        // 使用 Inter 作为基础，但增加一个衬线字体（如 KaiTi 或 SongTi）模拟古风
                        sans: ['Inter', 'serif'],
                        serif: ['STSong', 'SimSun', 'serif'], 
                        display: ['STKaiTi', 'serif'],
                    },
                    boxShadow: {
                        'scroll': '10px 10px 20px rgba(0, 0, 0, 0.5)',
                        'seal': '2px 2px 0 #8b2b2b',
                    }
                },
            }
        }
    </script>
    <style>
        /* 隐藏滚动条但允许滚动 */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }

        /* 古风按钮基础样式 */
        .gufu-btn {
            @apply inline-flex items-center justify-center px-6 py-2.5 font-display text-lg tracking-widest bg-accent-red text-paper rounded-lg shadow-seal hover:bg-red-700 transition duration-300 transform active:translate-y-0.5 active:shadow-none disabled:opacity-50 disabled:cursor-not-allowed;
        }
        
        /* 故事推进按钮加强样式 */
        .gufu-btn-primary {
            /* 添加发光效果和边框 */
            box-shadow: 0 0 15px rgba(168,58,58,0.7), 2px 2px 0 #8b2b2b;
            border: 2px solid #fbf8f0;
            @apply tracking-widest;
        }

        /* 故事内容的排版，模拟古籍 */
        .story-content p {
            @apply text-lg leading-relaxed mb-4 text-ink;
        }
        .story-content h2 {
            @apply font-display text-2xl font-bold mb-4 border-b border-ink/30 pb-2;
        }
        
        /* 章节导航项的样式 - 恢复为列表样式 */
        .toc-item {
            @apply p-3 cursor-pointer text-sm font-display text-ink hover:bg-wood-dark/10 transition duration-150 rounded-md flex items-center space-x-2;
        }
        .toc-node {
            @apply w-3 h-3 rounded-full border border-ink;
        }
        .toc-node.active {
            @apply bg-accent-red border-accent-red;
        }
        .toc-node.completed {
            @apply bg-green-600 border-green-600;
        }

        /* 隐藏地图模态框 */
        #map-modal {
            display: none !important;
        }
    </style>
</head>
<body class="bg-wood-dark min-h-screen font-serif flex justify-center items-center py-8 px-4">

    <div id="game-container" class="w-full max-w-6xl h-[90vh] bg-paper shadow-scroll rounded-xl overflow-hidden flex flex-col md:flex-row">

        <div id="story-panel" class="md:w-3/5 w-full h-1/2 md:h-full p-8 overflow-y-auto hide-scrollbar relative">
            
            <button id="back-button" class="absolute top-4 left-4 z-10 gufu-btn px-3 py-1 text-base hidden" onclick="goBack()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                故事回溯
            </button>
            
            <h1 class="text-4xl font-display text-center text-accent-red mb-6 border-b-2 border-accent-red/50 pb-3">
                天理劫：兴贤书院谜案
            </h1>

            <div id="story-text" class="story-content transition-opacity duration-500">
                </div>

            <div id="interaction-area" class="mt-8 border-t border-ink/20 pt-6">
                </div>
            
            <div id="scene-nav" class="mt-10 flex justify-center space-x-4">
                </div>
        </div>

        <div class="md:w-2/5 w-full h-1/2 md:h-full bg-wood-dark/10 p-6 overflow-y-auto hide-scrollbar flex flex-col space-y-6 border-l border-wood-dark/30">

            <div class="flex justify-between space-x-2 mb-4">
                <button id="toc-toggle" class="gufu-btn flex-1 text-sm px-4 py-2" onclick="toggleSidebar('toc')">章节导航</button>
                <button id="history-toggle" class="gufu-btn flex-1 text-sm px-4 py-2 opacity-70" onclick="toggleSidebar('history')">行动轨迹</button>
            </div>

            <div id="sidebar-toc" class="space-y-3">
                <h2 class="text-xl font-display text-ink border-b border-ink/30 pb-2 mb-3">故事地图（流程）</h2>
                </div>

            <div id="sidebar-history" class="space-y-2 hidden">
                <h2 class="text-xl font-display text-ink border-b border-ink/30 pb-2 mb-3">历史记录</h2>
                <div id="history-list" class="text-sm text-ink/80 space-y-1">
                    <p>旅程伊始...</p>
                </div>
            </div>

        </div>

    </div>

<script>
    // --- 全局变量与游戏状态 ---
    let gameData = {};
    let currentScene = 'intro';
    let sceneHistory = [];
    
    // 定义故事主线路径，用于精确回溯
    const storyPath = [
        'intro',
        'dot1_ritual',
        'dot2_jigsaw',
        'dot4_intro',
        'dot4_coronation',
        'dot5_intro',
        'dot5_fill',
        'dot6_intro',
        'dot6_judgement',
        'dot13_intro',
        'dot13_quiz',
        'final_teaching',
        'epilogue'
    ];
    
    // --- 场景数据定义 ---
    const scenes = {
        'intro': {
            title: "天理劫：兴贤书院谜案",
            content: `
                <h2 class="text-center font-display text-2xl font-bold mb-6 text-accent-red">序章：风雪五夫·道统飘零</h2>
                <p><strong>故事背景：：</strong>南宋庆元年间，五夫古镇中的兴贤书院，曾是朱熹讲学授道之所。然而，庆元二年，朝中风波骤起，理学被斥为“伪学”，朱子之学遭严禁。更致命的是， 朱熹《四书章注》的手稿，竟在混乱中离奇失窃。</p>
                <p><strong>你是谁：：</strong>你叫 <strong>陈观理</strong>，25岁，兴贤书院学子，沉着冷静，善于观察，深受朱熹影响。</p>
                <p>你身负恩师信念，收到密信，毅然踏入这迷局之中。你必须找回这份珍贵的手稿，洗刷泼向师门的污名，为乱世守住最后一点光明。</p>
                <p>墨卷无声，正道存心；书院深处，等你寻踪。</p>
            `,
            options: [{ text: "启程：前往兴贤书院", nextScene: 'dot1_ritual' }]
        },
        // 点位1：簪花祈福仪式
        'dot1_ritual': {
            title: "点位一：簪花祈福台 (仪式复原)",
            content: `
                <p>风雪漫五夫。当你踏进熟悉的兴贤书院，往日书声琅琅的景象已荡然无存。老仆迎上来，声音里带着惊惶：“他们不止烧书，连学子们祈愿前程的<strong>簪花祈福台</strong>，也给砸了！”</p>
                <p>你走向那片狼藉，老仆递来一本《簪花仪轨》：“公子，若能复原此礼，或能唤醒书院正气。”</p>
                <p><strong>请依序复原宋代学子考前仪式：</strong> 净手焚香 &rarr; 揖拜先师 &rarr; 簪花于冠 &rarr; 抽签得训 。</p>
            `,
            render: renderZanhuaRitual,
            nextScene: 'dot2_jigsaw',
            state: { step: 0, stepsComplete: [false, false, false, false], labels: ["净手", "焚香", "簪花", "揖拜先师"] }
        },
        // 点位2：拼图复原门图
        'dot2_jigsaw': {
            title: "点位二：门图拼图与锁的线索",
            content: `
                <p>你完成仪式后，老仆感动道：“昔年学子皆由此明志，今日重现，正气不灭！”</p>
                <p>随后，你在簪花台附近发现地上散落着一幅被割破的<strong>《兴贤书院门图》</strong>。你细心拼好，翻过来竟发现八个大字：“格物致知，诚意正心”。</p>
                <p>老仆人突然想起那伙人离开时喊了一句：“**清莲不染尘，乌纱须无垢**”。你仔细观察铜锁，发现锁上刻有莲花和官帽的图案。</p>
                <p><strong>任务：：</strong>请拼图复原门图，然后寻找线索打开铜锁。</p>
            `,
            render: renderJigsawAndLock,
            nextScene: 'dot4_intro', // 直接跳到下一场景的介绍
        },
        // 场景过渡：进入藏书阁
        'dot4_intro': {
            title: "第一幕：藏书阁的谜题",
            content: `
                <h2 class="text-center font-display text-2xl font-bold mb-6 text-accent-red">第一幕：藏书阁的谜题</h2>
                <p>“咔嗒——”铜锁弹开，你迈过门槛，破窗而入的光线照亮了满室狼藉。墙上炭涂大字：“伪礼当焚!”</p>
                <p>在狼藉中，你发现一个未被破损的礼器盒，里面盛放着举行成人礼所需的器物，但礼器旁的仪轨图被撕毁，顺序混乱。</p>
            `,
            options: [{ text: "复原成人礼仪轨", nextScene: 'dot4_coronation' }]
        },
        // 点位4：成人礼仪式
        'dot4_coronation': {
            title: "点位四：成人礼复原（三加之礼与赐字）",
            content: `
                <p>老仆叹息：“他们连成人之礼都要践踏！”你决定复原仪轨，从礼器中找到下一步的线索。</p>
                <p><strong>任务：：</strong>请先选择身份，然后将“三加之礼”的三个阶段正确排序。</p>
            `,
            render: renderCoronationRitual,
            nextScene: 'dot5_intro', // 进入下一场景介绍
            state: { identity: null, currentStep: 0, ceremonyDone: false, isSorting: false, sequence: [], wordChosen: null }
        },
        // 场景过渡：进入刘氏家祠
        'dot5_intro': {
            title: "第二幕：刘氏家祠的考验",
            content: `
                <h2 class="text-center font-display text-2xl font-bold mb-6 text-accent-red">第二幕：刘氏家祠的考验</h2>
                <p>你循着线索来到刘氏家祠，刘老正在给孩童们讲**“朱子托孤”**的故事。他递给你一支毛笔，让你补全纸上被虫蛀掉的关键名字。</p>
                <p>泛黄的纸上写着：“绍兴十三年，朱松公病笃建安，托孤于挚友█。朱熹时年十四，█筑室紫阳溪畔，亲授《论语》大义…” 仅存的半个 “羽” 字在纸缘摇曳。</p>
            `,
            options: [{ text: "补全托孤者之名", nextScene: 'dot5_fill' }]
        },
        // 点位5：补全名字
        'dot5_fill': {
            title: "点位五：补全托孤者之名",
            content: `
                <p><strong>任务：：</strong>根据刘氏一族四位显赫先人（刘韐公、刘子羽公、刘子翚公、刘珙公）和“筑室紫阳”的典故，选择正确的人物名字补全故事。</p>
            `,
            render: renderLiuFamilyTest,
            nextScene: 'dot6_intro'
        },
        // 场景过渡：进入社仓
        'dot6_intro': {
            title: "第三幕：社仓辨真假",
            content: `
                <h2 class="text-center font-display text-2xl font-bold mb-6 text-accent-red">第三幕：社仓辨真假</h2>
                <p>老仆急匆匆闯进祠堂：“公子！他们去**社仓**了！污蔑先生借社仓牟利！”</p>
                <p>你立刻前往朱子社仓。几名值守弟子正手忙脚乱，一本被篡改的《贷粮簿》混在其中，误导了他们的判断。</p>
            `,
            options: [{ text: "裁决社仓冤案", nextScene: 'dot6_judgement' }]
        },
        // 点位6：社仓裁决
        'dot6_judgement': {
            title: "点位六：社仓辨真假（裁决三案）",
            content: `
                <p><strong>任务：</strong>你面前摊开着《社仓手册》。请根据手册的仁义原则，对三个案例做出公正的裁决。</p>
            `,
            render: renderShecangJudgement,
            nextScene: 'dot13_intro',
            state: { currentCase: 0, cases: [
                { statement: "今年大旱，老农借一石米，值守弟子要求还一石三升。", correct: 'false', rule: "荒年赈济为本，息米皆免。" },
                { statement: "丰年佃户来归还借米，值守弟子要求连本带利共还三石米。", correct: 'false', rule: "丰年取息有度，不为盘剥，利息不得超过一成五。" },
                { statement: "平年寡妇无力偿还去年粮款，值守弟子坚持今日必须还清。", correct: 'false', rule: "鳏寡孤独者免耗，更应酌情延期或减免。" }
            ]}
        },
        // 场景过渡：进入五口井
        'dot13_intro': {
            title: "第四章：胡氏五贤井",
            content: `
                <h2 class="text-center font-display text-2xl font-bold mb-6 text-accent-red">第四章：胡氏五贤井</h2>
                <p>你发现了社仓夹层中的密信，以及梁上蟠龙雕饰的磁针指引：<strong>“亥时三刻井畔会，龙睛开处见天机。”</strong> 磁针指向东北方！五夫镇井群密布，你决定前往查看。</p>
                <p>你来到三市街，开始寻找五口古井。在探访了胡安国、胡宪、胡宏、胡寅四口井后，你终于来到了第五口井。</p>
            `,
            options: [{ text: "破解五口井的钥匙", nextScene: 'dot13_quiz' }]
        },
        // 点位13：五口井的钥匙
        'dot13_quiz': {
            title: "点位十三：五口井的钥匙（传承问答）",
            content: `
                <p>你找到了第五口井下的宝箱！但井边的石环上刻着一道谜题，唯有理脉相通者方可开启。</p>
            `,
            render: renderWellQuiz,
            nextScene: 'final_teaching',
            state: { answered: false }
        },
        // 最终章：理心问道
        'final_teaching': {
            title: "最终章：理心问道 (朱子巷)",
            content: `
                <h2 class="text-center font-display text-2xl font-bold mb-6 text-accent-red">最终章：理心问道 (朱子巷)</h2>
                <p>你带着《四书章注》手稿，踏入了再熟悉不过的**朱子巷**。前方，恩师朱熹的身影缓缓浮现。</p>
                <p>“观理，”先生的声音平静而有力，“你一路历经 辨伪、济民、寻真，可知 理在何处？”</p>
                <p>你回答：“回先生，理在书中，也在人心。”</p>
                <p>先生颔首，并向你抛出了三惑：同学讥笑、俗务纷杂、静坐杂念。你将如何选择，以更好地理解先生的教导？</p>
            `,
            render: renderFinalTeachings,
            nextScene: 'epilogue',
            state: { currentQuestion: 0, score: 0, questions: [
                { prompt: "应对琐事纷扰：总是觉得日常琐事打扰了重要的正事，在不同任务间切换，效率很低，感到非常焦虑。依尔之见，当如何破此困局？", options: ["远离尘嚣，避世读书。", "将每件琐事视为磨练专注力的机会，做事时心无旁骛，做完后迅速回归主线。", "索性放下一切，尽情放松，待心情好转再处理。"], correctIndex: 1, explanation: "善！‘事上磨心，专注即转换。’此乃学以致用、知行合一之真谛。" },
                { prompt: "应对内心杂念：我一静下来就胡思乱想，越是想专注，内心越是烦躁，根本无法平静。此时你当如何收心？", options: ["努力压制每一个念头，直到大脑一片空白。", "放任思绪流淌，想累了自然就停了。", "不去对抗杂念，而是专注于调整呼吸，如同提起衣领，心虚自会平顺。", "只去对抗杂念，不调整呼吸"], correctIndex: 2, explanation: "然也！‘心如衣领，一提则顺。’静坐非为枯守，乃是唤醒内心的觉知与主宰。" }
            ]}
        },
        // 结局
        'epilogue': {
            title: "结局：书院重现光明",
            content: `
                <h2 class="text-center font-display text-2xl font-bold mb-6 text-accent-red">结局：书院重现光明</h2>
                <p>朱熹先生赠言：“世虽万变，然有三事不可移：一曰立志，二曰持敬，三曰渐进。此手稿赠予你，传于后世。”</p>
                <p>你怀揣手稿重返书院，见孩童已在诵读《四书章注》，老仆含笑相迎。</p>
                <p>手稿归位，书院重现光明。</p>
                <p>你立于簪花台前，轻声道：“同窗讥笑乃磨志之石，俗务纷杂乃炼心之火，静坐杂念乃照妄之镜！愿持此三境，传理于后世。”</p>
                <div class="mt-8 text-center text-xl font-display text-accent-red border-t border-accent-red/50 pt-4">
                    🎉 恭喜你，完成了《天理劫：兴贤书院谜案》！
                </div>
            `,
            options: []
        }
    };
    
    // 章节导航数据 (指向各幕的起始页)
    const tocData = [
        { id: 'intro', title: '序章：风雪五夫' },
        { id: 'dot4_intro', title: '第一幕：藏书阁的谜题' },
        { id: 'dot5_intro', title: '第二幕：刘氏家祠的考验' },
        { id: 'dot6_intro', title: '第三幕：社仓辨真假' },
        { id: 'dot13_intro', title: '第四章：胡氏五贤井' },
        { id: 'final_teaching', title: '最终章：理心问道' },
        { id: 'epilogue', title: '结局：书院重现光明' }
    ];
    
    // 地图节点数据 (用于虚拟地图) - 此数据仅用于流程地图展示，不再用于复杂的SVG定位
    const mapNodes = [
        { id: 'intro', title: '兴贤书院 (起始)', scene: 'intro', chapter: 0 },
        { id: 'dot4_intro', title: '藏书阁 (谜题)', scene: 'dot4_intro', chapter: 1 },
        { id: 'dot5_intro', title: '刘氏家祠 (考验)', scene: 'dot5_intro', chapter: 2 },
        { id: 'dot6_intro', title: '朱子社仓 (辨真假)', scene: 'dot6_intro', chapter: 3 },
        { id: 'dot13_intro', title: '胡氏五贤井 (寻踪)', scene: 'dot13_intro', chapter: 4 },
        { id: 'final_teaching', title: '朱子巷 (问道/终章)', scene: 'final_teaching', chapter: 5 },
        { id: 'epilogue', title: '结局 (回顾)', scene: 'epilogue', chapter: 6 }
    ];


    // --- 核心函数 ---

    /**
     * 初始化游戏
     */
    function initGame() {
        const storedHistory = localStorage.getItem('mysteryBookHistory');
        const storedScene = localStorage.getItem('mysteryBookScene');

        // 初始化场景历史
        if (storedHistory) {
            sceneHistory = JSON.parse(storedHistory);
            // 重新渲染历史列表
            renderHistory(); 
        } else {
            sceneHistory = [];
        }

        // 初始化当前场景
        if (storedScene && scenes[storedScene]) {
             // 如果存储的场景有效，则跳转
            currentScene = storedScene;
            renderScene(currentScene, false);
        } else {
            // 否则从头开始
            setNextScene('intro');
        }
        
        // 渲染目录
        renderTOC();

        // 绑定切换事件
        // 重新获取 toc-toggle 元素
        document.getElementById('toc-toggle').addEventListener('click', () => toggleSidebar('toc'));
        document.getElementById('history-toggle').addEventListener('click', () => toggleSidebar('history'));
    }

    /**
     * 渲染当前场景
     * @param {string} sceneId - 场景ID
     * @param {boolean} record - 是否记录到历史 (回溯时不需要记录)
     */
    function renderScene(sceneId, record = true) {
        const scene = scenes[sceneId];
        const storyText = document.getElementById('story-text');
        const interactionArea = document.getElementById('interaction-area');
        const sceneNav = document.getElementById('scene-nav');
        const backButton = document.getElementById('back-button');

        // 1. 记录历史 (仅用于"行动轨迹"面板)
        if (record && currentScene !== sceneId) {
            // 注意：这里只记录到 sceneHistory，不再用于 goBack 逻辑
            sceneHistory.push(currentScene);
            renderHistory();
        }
        currentScene = sceneId;
        localStorage.setItem('mysteryBookScene', currentScene);
        localStorage.setItem('mysteryBookHistory', JSON.stringify(sceneHistory));

        // 2. 渲染基础内容
        storyText.innerHTML = scene.content;
        interactionArea.innerHTML = '';
        sceneNav.innerHTML = '';

        // 3. 渲染谜题/互动区
        if (scene.render) {
            scene.render();
        }

        // 4. 渲染导航按钮 (如果谜题未渲染，则显示普通导航)
        // 注意：点位1 (dot1_ritual) 的下一步按钮由谜题函数负责渲染
        if (!scene.render || (interactionArea.innerHTML === '' && sceneId !== 'dot1_ritual')) {
            if (scene.options) {
                scene.options.forEach(option => {
                    const button = document.createElement('button');
                    // 应用主线推进样式
                    button.className = 'gufu-btn gufu-btn-primary'; 
                    button.textContent = option.text;
                    button.onclick = () => setNextScene(option.nextScene);
                    sceneNav.appendChild(button);
                });
            }
        }
        
        // 5. 渲染回溯按钮
        const currentIndex = storyPath.indexOf(currentScene);
        if (currentIndex > 0) {
            backButton.classList.remove('hidden');
        } else {
            backButton.classList.add('hidden');
        }
        
        // 6. 标记 TOC 中的当前点
        renderTOC(); // 每次场景变化都更新导航状态
    }
    
    /**
     * 设置并渲染下一个场景
     * @param {string} sceneId - 下一个场景ID
     */
    function setNextScene(sceneId) {
        // 场景跳转前，清空互动区，避免残留状态影响下一个场景
        document.getElementById('interaction-area').innerHTML = ''; 
        renderScene(sceneId, true);
    }
    
    /**
     * **新逻辑：** 按照故事主线路径回溯。
     */
    window.goBack = () => {
        const currentIndex = storyPath.indexOf(currentScene);

        if (currentIndex > 0) {
            const lastMajorScene = storyPath[currentIndex - 1];
            
            // 重建 sceneHistory 到上一个主线点
            sceneHistory = storyPath.slice(0, currentIndex - 1);
            renderHistory();

            // 跳转到上一个主线场景 (不记录历史)
            renderScene(lastMajorScene, false); 
        }
    }
    
    /**
     * 渲染侧边栏的历史记录
     */
    function renderHistory() {
        const historyList = document.getElementById('history-list');
        historyList.innerHTML = '';
        if (sceneHistory.length === 0) {
            historyList.innerHTML = '<p class="text-ink/60">旅程伊始...</p>';
            return;
        }
        
        // 倒序显示，最新的在最上面
        [...sceneHistory].reverse().forEach((sceneId, index) => {
            const sceneTitle = scenes[sceneId]?.title || sceneId;
            const li = document.createElement('p');
            li.className = 'text-sm text-ink/80 border-b border-ink/10 pb-1';
            li.textContent = `[${sceneHistory.length - index}] ${sceneTitle}`;
            historyList.appendChild(li);
        });
    }
    
    /**
     * 渲染侧边栏的章节导航 (TOC) - 恢复为流程图式的文字导航
     */
    function renderTOC() {
        const tocContainer = document.getElementById('sidebar-toc');
        let html = '<h2 class="text-xl font-display text-ink border-b border-ink/30 pb-2 mb-3">故事地图（流程）</h2><div class="space-y-2">';

        const currentPathIndex = storyPath.indexOf(currentScene);

        mapNodes.forEach(node => {
            const nodeIndex = storyPath.indexOf(node.scene);
            const isCurrent = node.scene === currentScene || (nodeIndex !== -1 && currentPathIndex >= nodeIndex && currentPathIndex < storyPath.indexOf(mapNodes[mapNodes.indexOf(node) + 1]?.scene || 'epilogue'));
            const isCompleted = nodeIndex < currentPathIndex;
            const statusClass = isCurrent ? 'bg-accent-red active' : (isCompleted ? 'bg-green-600 completed' : 'bg-paper');

            html += `
                <div class="toc-item ${isCurrent ? 'bg-accent-red/20 font-bold' : ''}" 
                     data-scene="${node.scene}"
                     onclick="jumpToScene('${node.scene}')">
                    <span class="toc-node ${statusClass}"></span>
                    <span>${node.title}</span>
                </div>
            `;
        });

        html += '</div>';
        tocContainer.innerHTML = html;
    }
    
    /**
     * **新逻辑：** 跳转到指定场景 (会清空并重建主线历史)
     * @param {string} sceneId - 目标场景ID
     */
    window.jumpToScene = (sceneId) => {
        if (sceneId === currentScene) return;
        
        const targetIndex = storyPath.indexOf(sceneId);
        
        if (targetIndex !== -1) {
            // 将历史设置为从 intro 到目标场景之间的所有主线场景
            sceneHistory = storyPath.slice(0, targetIndex); 
        } else {
            // 如果目标场景不在主线路径上 (理论上不应该发生)，则清空历史
            sceneHistory = [];
        }
        
        renderHistory();
        
        // 渲染目标场景 (不记录历史，因为 history 已经被手动设置)
        renderScene(sceneId, false);
        
        toggleSidebar('toc'); 
        
    }
    
    /**
     * 切换侧边栏视图 (TOC或History)
     * @param {string} view - 'toc' 或 'history'
     */
    function toggleSidebar(view) {
        const toc = document.getElementById('sidebar-toc');
        const history = document.getElementById('sidebar-history');
        const tocToggle = document.getElementById('toc-toggle');
        const historyToggle = document.getElementById('history-toggle');

        if (view === 'toc') {
            toc.classList.remove('hidden');
            history.classList.add('hidden');
            tocToggle.classList.add('opacity-100');
            historyToggle.classList.remove('opacity-100');
            renderTOC(); // 确保TOC状态是最新的
        } else {
            toc.classList.add('hidden');
            history.classList.remove('hidden');
            tocToggle.classList.remove('opacity-100');
            historyToggle.classList.add('opacity-100');
            renderHistory(); // 确保历史记录是最新的
        }
    }
    
    // 赐字数据
    const wordOptions = {
        "修身心性类": [
            { word: "敬斋", desc: "居处恭，执事敬，以内直外，是谓敬斋。——敬字工夫，乃是圣门第一义。" },
            { word: "诚明", desc: "由真诚而明善德，因明德而达至诚。——诚则明矣，明则诚矣。" },
            { word: "涵甫", desc: "涵养此心，须用敬之功夫，如水之深蓄。——涵养须用敬，进学则在致知。" },
            { word: "慎独", desc: "人所不知而已所独知之地，尤当谨慎。——君子慎其独也。" },
        ],
        "宇宙本体类": [
            { word: "理初", desc: "穷究万化之初始，莫不有理。——理在气先。" },
            { word: "太极", desc: "总天地万物之理，便是太极。——太极只是一个理字。" },
            { word: "道原", desc: "道为理之统名，探其本源，方得究竟。——道即理之谓也。" },
            { word: "性天", desc: "性即理也，其所从来，源于天命。——性乃天所命，理之所在。" },
        ],
        "为学之道类": [
            { word: "格庵", desc: "于书斋中格万物之理，在事为上致本心之知。——格物致知。" },
            { word: "穷理", desc: "即物而穷其理，以求至乎其极。——所谓致知在格物者，言欲致吾之知，在即物而穷其理也。" },
            { word: "知本", desc: "知所先后，则近道矣。万事须从根本理会。——务本力行，以渐而进。" },
            { word: "贯一", desc: "散于万物之理，由一以贯之。——一以贯之。" },
        ],
        "理想境界类": [
            { word: "希贤", desc: "士希贤，贤希圣，心存高远，步履坚实。——为学须思所以超凡入圣。" },
            { word: "明德", desc: "明明德于天下，自昭其明德。——明德者，人之所得乎天，至明而不昧者也。" },
            { word: "天游", desc: "心与天游，上下同流，是为天人合一。——心广大如天地，虚明如日月。" },
            { word: "泉涌", desc: "默识心通，触处逢源，如泉之涌。——潜心积虑，默识心通，则自然有洒然处。" },
        ]
    };


    // --- 谜题渲染函数 ---

    /**
     * 点位1：簪花祈福仪式
     * 已修改：将随机抽签改为玩家选择签文。
     */
    function renderZanhuaRitual() {
        const interactionArea = document.getElementById('interaction-area');
        const scene = scenes['dot1_ritual'];
        let { step, stepsComplete, labels } = scene.state;

        const ritualSteps = labels.map((label, index) => {
            const isCurrent = index === step;
            const isCompleted = stepsComplete[index];
            const iconMap = ["💧", "🔥", "🌸", "🙏"];
            
            return `
                <button id="ritual-btn-${index}" 
                        class="flex flex-col items-center justify-center p-4 m-2 rounded-xl transition duration-300 transform 
                        ${isCompleted ? 'bg-green-100/50 text-green-700 opacity-70 cursor-default' : isCurrent ? 'bg-accent-red/20 hover:bg-accent-red/30 shadow-md' : 'bg-paper/50 hover:bg-wood-dark/10 shadow-sm'} 
                        ${index > step ? 'opacity-40 cursor-default' : ''}" 
                        onclick="handleRitualStep(${index})"
                        ${isCompleted || index > step ? 'disabled' : ''}>
                    <span class="text-4xl">${iconMap[index]}</span>
                    <span class="mt-2 text-ink text-sm">${label}</span>
                </button>
            `;
        }).join('');

        // 按钮改为“完成仪式”
        const drawButton = `
            <button id="draw-sign-btn" class="gufu-btn gufu-btn-primary mt-6" onclick="showSignOptions()" ${stepsComplete.every(s => s) ? '' : 'disabled'}>
                完成仪式，选择签筒
            </button>
        `;

        interactionArea.innerHTML = `
            <div class="flex justify-center flex-wrap" id="ritual-buttons-container">${ritualSteps}</div>
            <div class="text-center mt-6" id="draw-sign-container">${drawButton}</div>
            <div id="sign-result" class="mt-6 text-center font-display text-lg text-green-700"></div>
        `;
        
        // 如果仪式已完成，则直接显示签文选项，覆盖按钮。
        if (stepsComplete.every(s => s)) {
            showSignOptions(true);
        }
    }

    // 处理仪式步骤点击 (只修改最后的提示)
    window.handleRitualStep = (index) => {
        const scene = scenes['dot1_ritual'];
        let { step, stepsComplete, labels } = scene.state;
        const interactionArea = document.getElementById('interaction-area');

        if (index === step) {
            stepsComplete[index] = true;
            
            if (index < labels.length - 1) {
                step++;
                scene.state.step = step;
                // 提示下一个步骤
                const nextStepLabel = labels[step];
                interactionArea.querySelector('#sign-result').innerHTML = `<p class="text-accent-red">✅ ${labels[index]} 礼成！<br>请进行下一步：【${nextStepLabel}】</p>`;
                
                // 如果是揖拜，则立即完成
                if (step === labels.length - 1) {
                     stepsComplete[step] = true;
                     scene.state.stepsComplete = stepsComplete;
                     interactionArea.querySelector('#draw-sign-btn').disabled = false;
                     interactionArea.querySelector('#sign-result').innerHTML = `<p class="text-green-700">🎉 揖拜先师，仪轨复原！请选择签筒。</p>`;
                }
            } else {
                 // 最后一个步骤完成
                 scene.state.stepsComplete = stepsComplete;
                 interactionArea.querySelector('#sign-result').innerHTML = `<p class="text-green-700">🎉 揖拜先师，仪轨复原！请选择签筒。</p>`;
            }
            
            renderZanhuaRitual();
        } else {
            interactionArea.querySelector('#sign-result').innerHTML = '<p class="text-red-600">❌ 顺序有误！请依循仪轨步骤。</p>';
        }
    };
    
    // 新增函数：显示三个签文选项
    window.showSignOptions = (isInitialRender = false) => {
        const interactionArea = document.getElementById('interaction-area');
        
        // 签文选项
        const signs = [
            { name: "勤学签", text: "读书之法，在循序而渐进，熟读而精思。——愿尔持之以恒，终有所成。", color: 'bg-blue-100/50 text-blue-700' },
            { name: "静心签", text: "心不定，故见理不得。今而后，汝当静坐收心，涵养本原。", color: 'bg-purple-100/50 text-purple-700' },
            { name: "弘志签", text: "立志不坚，终不济事。——愿尔胸怀大志，格物穷理。", color: 'bg-yellow-100/50 text-yellow-700' }
        ];

        const optionsHtml = signs.map((sign, index) => `
            <button class="flex-1 gufu-btn flex-col items-center p-4 m-2 text-base ${sign.color}" 
                    onclick="selectSign(${index}, '${sign.name}', '${sign.text.replace(/'/g, "\\'")}')">
                <span class="text-xl font-display">${sign.name}</span>
                <span class="text-xs opacity-80 mt-1">（点击选择此签）</span>
            </button>
        `).join('');
        
        // 如果是通过点击按钮进入，先清空按钮
        if (!isInitialRender) {
             document.getElementById('draw-sign-container').innerHTML = ''; 
        }

        // 插入选择区
        let signOptionsArea = document.getElementById('sign-options-area');
        if (!signOptionsArea) {
             signOptionsArea = document.createElement('div');
             signOptionsArea.id = 'sign-options-area';
             signOptionsArea.className = 'mt-6 p-4 bg-wood-dark/10 rounded-lg shadow-inner';
             interactionArea.appendChild(signOptionsArea);
        }
        
        signOptionsArea.innerHTML = `
            <p class="text-xl font-display text-accent-red mb-4 text-center">📜 请选择签筒，得获训诫</p>
            <div class="flex justify-center flex-wrap">${optionsHtml}</div>
            <div id="selected-sign-display" class="mt-4 text-center"></div>
        `;
    }

    // 新增函数：玩家选择签文
    window.selectSign = (index, name, text) => {
        const signOptionsArea = document.getElementById('sign-options-area');
        const selectedSignDisplay = document.getElementById('selected-sign-display');
        
        // 禁用所有选择按钮
        document.querySelectorAll('#sign-options-area button').forEach(btn => btn.disabled = true);

        // 显示结果
        selectedSignDisplay.innerHTML = `
            <div class="p-6 bg-green-100/50 rounded-lg shadow-inner mt-4">
                <p class="text-xl font-display text-accent-red mb-4">🎉 恭得【${name}】！</p>
                <p class="text-ink text-lg">${text}</p>
            </div>
        `;

        // 显示下一步按钮
        const sceneNav = document.getElementById('scene-nav');
        sceneNav.innerHTML = `<button class="gufu-btn gufu-btn-primary" onclick="setNextScene('dot2_jigsaw')">进入点位二 (拼图)</button>`;
    }

    /**
     * 点位2：拼图复原门图 (简化为点击完成)
     */
    function renderJigsawAndLock() {
        const interactionArea = document.getElementById('interaction-area');
        interactionArea.innerHTML = `
            <div id="jigsaw-area" class="p-6 bg-wood-dark/10 rounded-lg text-center">
                <p class="text-lg mb-4 text-ink"><strong>任务：</strong>请复原被割破的《兴贤书院门图》。</p>
                <div class="inline-block p-4 bg-paper/70 rounded-md border border-ink/20">
                    <img src="https://placehold.co/300x150/f0f0f0/333333?text=门图碎片" alt="[兴贤书院门图碎片]" class="rounded">
                </div>
            </div>
            <div id="lock-result" class="mt-6 text-center">
                <button class="gufu-btn gufu-btn-primary" onclick="completeJigsaw()">
                    我已拼好并发现背面线索
                </button>
            </div>
        `;
    }

    // 完成拼图
    window.completeJigsaw = () => {
        const interactionArea = document.getElementById('interaction-area');
        interactionArea.innerHTML = `
            <div class="p-6 bg-green-100/50 rounded-lg text-center">
                <p class="text-xl font-display text-green-700 mb-4">拼图完成！</p>
                <p class="text-2xl font-display text-ink">“格物致知，诚意正心”</p>
                <p class="text-lg mt-4 text-ink/70">你猛然想起朱熹讲易经时说“大衍之数五十，其用四十有九”，于是轻触最中央那颗星——锁，应声而开。</p>
            </div>
        `;
        // 显示下一步按钮
        const sceneNav = document.getElementById('scene-nav');
        sceneNav.innerHTML = `<button class="gufu-btn gufu-btn-primary" onclick="setNextScene('dot4_intro')">进入藏书阁</button>`;
    };

    /**
     * 点位4：成人礼仪式
     */
    function renderCoronationRitual() {
        const interactionArea = document.getElementById('interaction-area');
        const scene = scenes['dot4_coronation'];

        if (!scene.state.identity) {
            // 选择身份阶段
            interactionArea.innerHTML = `
                <p class="text-lg mb-4"><strong>选择身份：</strong></p>
                <div class="flex justify-center space-x-6">
                    <button class="gufu-btn flex-1" onclick="selectIdentity('male')">冠礼 (男子成年礼)</button>
                    <button class="gufu-btn flex-1" onclick="selectIdentity('female')">笄礼 (女子成年礼)</button>
                </div>
            `;
        } else if (!scene.state.ceremonyDone) {
            // 三加之礼排序阶段
            const identity = scene.state.identity;
            
            // 定义完整的步骤，并确保在 selectIdentity 时已经打乱并初始化了 completed 属性
            if (scene.state.sequence.length === 0) {
                 window.selectIdentity(identity); // 确保初始化
                 return;
            }

            const currentOrder = scene.state.sequence;
            const stepLabels = ["初加", "二加", "三加"];
            const currentStepLabel = stepLabels[scene.state.currentStep]; // 修正后的 label 获取

            const sequenceDisplay = currentOrder.map((step, index) => {
                const isCurrentExpected = step.order === (scene.state.currentStep + 1); // 期待的下一个步骤 order (1, 2, or 3)
                const isCompleted = step.completed;

                return `
                    <div id="step-item-${index}" class="p-4 bg-paper/70 rounded-lg shadow-md flex items-center justify-between transition duration-200 
                        ${isCompleted ? 'bg-green-100/50 opacity-70 line-through' : isCurrentExpected ? 'border-2 border-accent-red' : ''}
                    ">
                        <span>${step.label}</span>
                        <button class="gufu-btn text-sm px-3 py-1" onclick="selectStep(${step.order})" ${isCompleted || scene.state.ceremonyDone ? 'disabled' : ''}>
                            ${isCompleted ? '✅ 已加' : '选择'}
                        </button>
                    </div>
                `;
            }).join('');

            interactionArea.innerHTML = `
                <p class="text-xl font-display text-accent-red mb-4">【${identity === 'male' ? '冠礼' : '笄礼'}】三加之礼</p>
                <p class="text-lg mb-4 text-ink"><strong>任务：</strong>请按“初加 &rarr; 二加 &rarr; 三加”的正确顺序点击。当前应选择：<span class="text-accent-red font-bold">${currentStepLabel || '初加'}</span></p>
                <div id="sequence-list" class="space-y-3">${sequenceDisplay}</div>
                <div id="coronation-message" class="mt-6 text-center text-red-600"></div>
            `;
        } else {
             // 赐字阶段: 玩家未选择字时，显示签筒
            if (!scene.state.wordChosen) {
                 const signBoxes = Object.keys(wordOptions).map(cat => `
                    <div class="p-4 bg-wood-dark/10 rounded-lg cursor-pointer hover:bg-wood-dark/20 transition duration-150" onclick="showWordOptions('${cat}')">
                        <p class="text-lg font-display text-accent-red">${cat}</p>
                        <p class="text-sm text-ink/70">（点击查看赐字）</p>
                    </div>
                `).join('');

                interactionArea.innerHTML = `
                    <p class="text-xl font-display text-accent-red mb-4">礼成！请选择签筒，获赐成人字。</p>
                    <div id="category-selection" class="grid grid-cols-2 gap-4 text-center">${signBoxes}</div>
                    <div id="word-options-area" class="mt-6"></div>
                `;
            } else {
                // 赐字已选定，显示结果和下一步按钮
                const chosen = scene.state.wordChosen;
                interactionArea.innerHTML = `
                    <div class="text-center p-6 bg-green-100/50 rounded-lg shadow-inner">
                        <p class="text-xl font-display text-accent-red mb-2">🎁 恭获赐字</p>
                        <p class="text-5xl font-display text-wood-dark mb-4">${chosen.word}</p>
                        <p class="text-lg font-display text-ink mb-4">朱子训：</p>
                        <p class="text-base text-ink/80">${chosen.desc}</p>
                    </div>
                `;
                // 显示下一步按钮
                const sceneNav = document.getElementById('scene-nav');
                sceneNav.innerHTML = `<button class="gufu-btn gufu-btn-primary" onclick="setNextScene('dot5_intro')">继续 (发现薄绢线索)</button>`;
            }
        }
    }

    // 新增函数：点击类别后展示所有可选的赐字和解释
    window.showWordOptions = (category) => {
        const wordList = wordOptions[category];
        const wordOptionsArea = document.getElementById('word-options-area');
        const selectionHtml = wordList.map(item => `
            <div class="p-3 bg-paper/70 rounded-lg shadow-md hover:bg-wood-dark/10 transition duration-150 cursor-pointer" onclick="chooseFinalWord('${item.word}', '${item.desc.replace(/'/g, "\\'")}')">
                <p class="text-2xl font-display text-accent-red">${item.word}</p>
                <p class="text-sm text-ink/70 mt-1">${item.desc.split('——')[0]}...</p>
            </div>
        `).join('');

        wordOptionsArea.innerHTML = `
            <h3 class="text-lg font-display text-ink mb-3 border-b border-ink/20 pb-1">【${category}】可选赐字（点击选择）</h3>
            <div class="grid grid-cols-2 gap-3">${selectionHtml}</div>
        `;
        
        // 禁用签筒点击
        document.getElementById('category-selection').classList.add('opacity-50');
        document.querySelectorAll('#category-selection > div').forEach(el => el.onclick = null);
    }
    
    // 新增函数：玩家选择最终的赐字
    window.chooseFinalWord = (word, desc) => {
        const scene = scenes['dot4_coronation'];
        scene.state.wordChosen = { word, desc };
        renderCoronationRitual(); // 重新渲染到结果页面
    }

    // 洗牌函数
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    window.selectIdentity = (identity) => {
        const ceremonySteps = identity === 'male' ? 
            [{ label: "初加: 缁布冠", order: 1, completed: false }, { label: "二加: 皮弁", order: 2, completed: false }, { label: "三加: 爵弁", order: 3, completed: false }] :
            [{ label: "初加: 发簪", order: 1, completed: false }, { label: "二加: 发钗", order: 2, completed: false }, { label: "三加: 钗冠", order: 3, completed: false }];

        scenes['dot4_coronation'].state.identity = identity;
        scenes['dot4_coronation'].state.sequence = shuffleArray(ceremonySteps);
        scenes['dot4_coronation'].state.currentStep = 0;
        scenes['dot4_coronation'].state.ceremonyDone = false;
        scenes['dot4_coronation'].state.wordChosen = null; // 重置赐字选择
        renderCoronationRitual();
    };

    window.selectStep = (selectedOrder) => {
        const scene = scenes['dot4_coronation'];
        const messageBox = document.getElementById('coronation-message');
        const expectedOrder = scene.state.currentStep + 1; // 1, 2, or 3

        if (selectedOrder === expectedOrder) {
            
            // 1. 标记为已完成
            const selectedItem = scene.state.sequence.find(s => s.order === selectedOrder);
            if (selectedItem) {
                selectedItem.completed = true;
            }

            scene.state.currentStep++; // 前进到下一个阶段
            
            // BUG FIX: 修正了判断逻辑。当 currentStep 达到 3 时，表示“三加”已完成。
            if (scene.state.currentStep >= 3) {
                // 仪式完成
                scene.state.ceremonyDone = true;
                messageBox.innerHTML = '<span class="text-green-700">🎉 成人仪轨完整复原！</span>';
            } else {
                // 准备下一个步骤的提示
                const currentStageLabel = ["初加", "二加", "三加"][selectedOrder - 1];
                messageBox.innerHTML = `<span class="text-green-700">✅ ${currentStageLabel} 礼成！请选择【${["初加", "二加", "三加"][scene.state.currentStep]}】。</span>`;
            }
            
            renderCoronationRitual(); // 重新渲染以反映新状态
            
        } else {
            messageBox.innerHTML = '<span class="text-red-600">❌ 顺序有误！请依循“初加、二加、三加”之序。您应选择【' + ["初加", "二加", "三加"][scene.state.currentStep] + '】。</span>';
        }
    };
    
    window.chooseWord = (category, words) => {
        // 此函数不再使用，功能被 showWordOptions/chooseFinalWord 取代
    };
    
    /**
     * 点位5：刘氏家祠考验
     */
    function renderLiuFamilyTest() {
        const interactionArea = document.getElementById('interaction-area');
        const options = [
            { name: "刘韐公", info: "抗金殉国的忠烈之士" },
            { name: "刘子羽公", info: "庇护理学的坚实砥柱" }, // Correct
            { name: "刘子翚公", info: "力斥议和的刚正之臣" },
            { name: "刘珙公", info: "承续文脉的儒学大家" }
        ];

        const optionsHtml = options.map((opt, index) => `
            <button class="gufu-btn flex-1 flex-col items-center p-4 m-2 text-sm" 
                    onclick="checkLiuTest('${opt.name}', this)">
                <span class="text-lg">${opt.name}</span>
                <span class="text-xs opacity-80 mt-1">(${opt.info})</span>
            </button>
        `).join('');

        interactionArea.innerHTML = `
            <p class="text-lg mb-4"><strong>任务：</strong>请选择受朱松公托孤，并在紫阳溪畔为朱熹筑室授经的恩师/义父。</p>
            <div id="liu-options" class="flex flex-wrap justify-center">${optionsHtml}</div>
            <div id="liu-test-result" class="mt-6 text-center"></div>
        `;
    }

    // 检查刘氏家祠答案
    window.checkLiuTest = (selection, button) => {
        const resultBox = document.getElementById('liu-test-result');
        document.querySelectorAll('#liu-options button').forEach(btn => btn.disabled = true);

        if (selection === "刘子羽公") {
            resultBox.innerHTML = `
                <div class="p-4 bg-green-100/50 rounded-lg text-green-700">
                    <p class="text-xl font-display mb-2">✅ 正确！</p>
                    <p>“必是子羽公！他受托孤重任，筑室授经，乃是先生义父。刘氏一门 ‘三忠一文’，忠义传家，方才护得理学薪火相传！”</p>
                </div>
            `;
            // 启用下一步
            const sceneNav = document.getElementById('scene-nav');
            sceneNav.innerHTML = `<button class="gufu-btn gufu-btn-primary" onclick="setNextScene('dot6_intro')">前往社仓</button>`;
        } else {
            resultBox.innerHTML = `
                <div class="p-4 bg-red-100/50 rounded-lg text-red-700">
                    <p class="text-xl font-display mb-2">❌ 谬矣！</p>
                    <p>请仔细回想“筑室紫阳”之典故，唯有他受托孤重任。请重新思考。</p>
                </div>
            `;
            document.querySelectorAll('#liu-options button').forEach(btn => btn.disabled = false); // 允许重试
            button.classList.add('opacity-50'); // 标记错误选项
        }
    };
    
    /**
     * 点位6：社仓裁决
     */
    function renderShecangJudgement() {
        const interactionArea = document.getElementById('interaction-area');
        const scene = scenes['dot6_judgement'];
        let { currentCase, cases } = scene.state;

        if (currentCase >= cases.length) {
            interactionArea.innerHTML = `
                <div class="p-6 bg-green-100/50 rounded-lg text-green-700">
                    <p class="text-xl font-display mb-4">🎉 三案裁决公正！</p>
                    <p>你公正的裁决，让老农热泪盈眶。他颤颤巍巍地告诉你：“那帮天杀的，搬来了几个新粮斗，就放在最里面那个角落。亥时三刻井畔会…”</p>
                </div>
            `;
            const sceneNav = document.getElementById('scene-nav');
            sceneNav.innerHTML = `<button class="gufu-btn gufu-btn-primary" onclick="setNextScene('dot13_intro')">前往五贤井</button>`;
            return;
        }

        const current = cases[currentCase];

        // 社仓手册规则
        const rulesHtml = `
            <div class="p-3 mb-4 bg-wood-dark/10 rounded-lg border-l-4 border-accent-red/70">
                <p class="text-lg font-display text-accent-red mb-2">《社仓手册》规定 (仁义为本)</p>
                <ul class="list-disc list-inside text-ink text-sm space-y-1">
                    <li><strong>荒年赈济为本，息米皆免。</strong></li>
                    <li><strong>丰年取息有度，不为盘剥</strong> (利息不得超过一成五)。</li>
                    <li><strong>鳏寡孤独者免耗</strong>，更应酌情延期或减免本金。</li>
                </ul>
            </div>
        `;

        interactionArea.innerHTML = `
            ${rulesHtml}
            <p class="text-lg mb-4"><strong>案件 ${currentCase + 1} / ${cases.length}：</strong></p>
            <div class="p-4 bg-paper/70 rounded-lg shadow-md mb-6">
                <p class="text-ink">${current.statement}</p>
                <p class="text-sm mt-2 text-ink/70">值守弟子方案：【${current.statement.match(/值守弟子方案：(.*?)(。|\.|$)/)?.[1] || '（见案件描述）'}】</p>
            </div>
            
            <div class="flex justify-center space-x-6">
                <button class="gufu-btn flex-1" onclick="checkJudgement('false', '${current.correct}', '${current.rule}')">裁决：❌ 错误</button>
                <button class="gufu-btn flex-1" onclick="checkJudgement('true', '${current.correct}', '${current.rule}')">裁决：✅ 正确</button>
            </div>
            <div id="judgement-result" class="mt-6 text-center"></div>
        `;
    }
    
    // 检查社仓裁决答案
    window.checkJudgement = (playerAnswer, correctAnswer, rule) => {
        const resultBox = document.getElementById('judgement-result');
        const scene = scenes['dot6_judgement'];
        
        document.querySelectorAll('#interaction-area button').forEach(btn => btn.disabled = true);

        // 裁决正确逻辑：因为所有案例中，值守弟子的方案都是错误的，所以正确裁决应该是“错误”。
        // 因此，我们只需要检查玩家的选择是否与预设的正确答案（'false'）一致即可。
        // NOTE: 我根据您提供的案例内容（值守弟子方案皆错），修正了按钮点击和判断逻辑。
        if ((playerAnswer === 'false' && correctAnswer === 'false') || (playerAnswer === 'true' && correctAnswer === 'true')) {
            resultBox.innerHTML = `
                <div class="p-4 bg-green-100/50 rounded-lg text-green-700">
                    <p class="text-xl font-display mb-2">✅ 明断！</p>
                    <p>朱熹虚影：“善！社仓之设，贵在‘义’。你秉公执法，不为私利所惑。”</p>
                </div>
            `;
            scene.state.currentCase++;
            setTimeout(renderShecangJudgement, 2000);
        } else {
            resultBox.innerHTML = `
                <div class="p-4 bg-red-100/50 rounded-lg text-red-700">
                    <p class="text-xl font-display mb-2">❌ 错判！</p>
                    <p>朱熹虚影：“大错特错！社仓乃仁心仁术，${rule}。请根据手册，重新思考此案。”</p>
                </div>
            `;
            document.querySelectorAll('#interaction-area button').forEach(btn => btn.disabled = false); // 允许重试
        }
    };

    /**
     * 点位13：五口井的钥匙
     */
    function renderWellQuiz() {
        const interactionArea = document.getElementById('interaction-area');
        const scene = scenes['dot13_quiz'];
        
        const quizHtml = `
            <p class="text-lg mb-6"><strong>题目：</strong>胡氏家学源远流长，最终由谁直接传授于朱熹先生，成为理学传承的关键一环？</p>
            <div id="quiz-options" class="space-y-3">
                <button class="gufu-btn w-full text-base py-3" onclick="checkWellQuiz('A', this)">A. 胡安国 → 胡宏 → 朱熹</button>
                <button class="gufu-btn w-full text-base py-3" onclick="checkWellQuiz('B', this)">B. 胡安国 → 胡寅 → 朱熹</button>
                <button class="gufu-btn w-full text-base py-3" onclick="checkWellQuiz('C', this)">C. 胡安国 → 胡宪 → 朱熹</button>
                <button class="gufu-btn w-full text-base py-3" onclick="checkWellQuiz('D', this)">D. 胡宏 → 胡寅 → 朱熹</button>
            </div>
            <div id="quiz-result" class="mt-6 text-center"></div>
        `;

        interactionArea.innerHTML = quizHtml;
        
        if (scene.state.answered) {
            document.querySelectorAll('#quiz-options button').forEach(btn => btn.disabled = true);
            const sceneNav = document.getElementById('scene-nav');
            sceneNav.innerHTML = `<button class="gufu-btn gufu-btn-primary" onclick="setNextScene('final_teaching')">最终章：朱子巷</button>`;
        }
    }

    // 检查五口井谜题答案
    window.checkWellQuiz = (answer, button) => {
        const resultBox = document.getElementById('quiz-result');
        const scene = scenes['dot13_quiz'];
        
        document.querySelectorAll('#quiz-options button').forEach(btn => btn.disabled = true);

        if (answer === 'C') {
            resultBox.innerHTML = `
                <div class="p-4 bg-green-100/50 rounded-lg text-green-700">
                    <p class="text-xl font-display mb-2">✅ 机关应声而解！</p>
                    <p>胡宪乃朱熹之师，胡氏家学由此一脉相承！《四书章注》手稿就在箱子里！</p>
                </div>
            `;
            scene.state.answered = true;
            const sceneNav = document.getElementById('scene-nav');
            sceneNav.innerHTML = `<button class="gufu-btn gufu-btn-primary" onclick="setNextScene('final_teaching')">最终章：朱子巷</button>`;
        } else {
            resultBox.innerHTML = `
                <div class="p-4 bg-red-100/50 rounded-lg text-red-700">
                    <p class="text-xl font-display mb-2">❌ 理脉未通！</p>
                    <p>石环发出低沉的嗡鸣。请再思之，朱熹之师是谁？</p>
                </div>
            `;
            document.querySelectorAll('#quiz-options button').forEach(btn => btn.disabled = false); // 允许重试
            button.classList.add('opacity-50'); // 标记错误选项
        }
    };

    /**
     * 点位14：理心问道
     */
    function renderFinalTeachings() {
        const interactionArea = document.getElementById('interaction-area');
        const scene = scenes['final_teaching'];
        let { currentQuestion, questions, score } = scene.state;

        if (currentQuestion >= questions.length) {
            interactionArea.innerHTML = `
                <div class="p-6 bg-green-100/50 rounded-lg text-green-700">
                    <p class="text-xl font-display mb-4">🎉 理心已明，忧惑渐消！</p>
                    <p>朱熹赠言：“知困而能求解，已是向学之心。切记，功夫在平日，循序渐进而已。”</p>
                </div>
            `;
            const sceneNav = document.getElementById('scene-nav');
            sceneNav.innerHTML = `<button class="gufu-btn gufu-btn-primary" onclick="setNextScene('epilogue')">结束旅程</button>`;
            return;
        }

        const current = questions[currentQuestion];
        const optionsHtml = current.options.map((opt, index) => `
            <button class="gufu-btn w-full text-base py-3" onclick="checkFinalTeaching(${index}, ${current.correctIndex}, '${current.explanation}')">
                ${String.fromCharCode(65 + index)}. ${opt}
            </button>
        `).join('');

        interactionArea.innerHTML = `
            <p class="text-lg mb-4"><strong>问心第 ${currentQuestion + 1} 惑：</strong></p>
            <div class="p-4 bg-wood-dark/10 rounded-lg shadow-inner mb-6">
                <p class="text-ink">${current.prompt}</p>
            </div>
            
            <div id="final-options" class="space-y-3">${optionsHtml}</div>
            <div id="final-result" class="mt-6 text-center"></div>
        `;
    }

    // 检查理心问道答案
    window.checkFinalTeaching = (playerIndex, correctIndex, explanation) => {
        const resultBox = document.getElementById('final-result');
        const scene = scenes['final_teaching'];
        
        document.querySelectorAll('#final-options button').forEach(btn => btn.disabled = true);

        if (playerIndex === correctIndex) {
            resultBox.innerHTML = `
                <div class="p-4 bg-green-100/50 rounded-lg text-green-700">
                    <p class="text-xl font-display mb-2">✅ 心理契合！</p>
                    <p>${explanation}</p>
                </div>
            `;
            scene.state.score++;
            scene.state.currentQuestion++;
            setTimeout(renderFinalTeachings, 3000);
        } else {
            resultBox.innerHTML = `
                <div class="p-4 bg-red-100/50 rounded-lg text-red-700">
                    <p class="text-xl font-display mb-2">❌ 仍有迷惘！</p>
                    <p>请仔细思考先生“事上磨心”和“心如衣领”的教诲，再行选择。</p>
                </div>
            `;
            document.querySelectorAll('#final-options button').forEach(btn => btn.disabled = false); // 允许重试
            document.querySelectorAll('#final-options button')[playerIndex].classList.add('opacity-50', 'bg-red-200'); // 标记错误选项
        }
    };


    // --- 页面加载启动游戏 ---
    window.onload = function() {
        initGame();
    };

</script>

</body>
</html>
