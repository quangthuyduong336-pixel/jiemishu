<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©ç†åŠ«ï¼šå…´è´¤ä¹¦é™¢è°œæ¡ˆ - æ²‰æµ¸å¼è§£è°œä½“éªŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'paper': '#fbf8f0', // ä»¿å¤çº¸å¼ è‰²
                        'ink': '#2c3e50', // å¢¨é»‘è‰²
                        'wood-dark': '#4b3b3b', // æ·±æœ¨è‰²èƒŒæ™¯
                        'accent-red': '#a83a3a', // å°ç« çº¢
                    },
                    fontFamily: {
                        // ä½¿ç”¨ Inter ä½œä¸ºåŸºç¡€ï¼Œä½†å¢åŠ ä¸€ä¸ªè¡¬çº¿å­—ä½“ï¼ˆå¦‚ KaiTi æˆ– SongTiï¼‰æ¨¡æ‹Ÿå¤é£
                        sans: ['Inter', 'serif'],
                        serif: ['STSong', 'SimSun', 'serif'], 
                        display: ['STKaiTi', 'serif'],
                    },
                    boxShadow: {
                        'scroll': '10px 10px 20px rgba(0, 0, 0, 0.5)',
                        'seal': '2px 2px 0 #8b2b2b',
                    }
                },
            }
        }
    </script>
    <style>
        /* éšè—æ»šåŠ¨æ¡ä½†å…è®¸æ»šåŠ¨ */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }

        /* å¤é£æŒ‰é’®åŸºç¡€æ ·å¼ */
        .gufu-btn {
            @apply inline-flex items-center justify-center px-6 py-2.5 font-display text-lg tracking-widest bg-accent-red text-paper rounded-lg shadow-seal hover:bg-red-700 transition duration-300 transform active:translate-y-0.5 active:shadow-none disabled:opacity-50 disabled:cursor-not-allowed;
        }
        
        /* æ•…äº‹æ¨è¿›æŒ‰é’®åŠ å¼ºæ ·å¼ */
        .gufu-btn-primary {
            /* æ·»åŠ å‘å…‰æ•ˆæœå’Œè¾¹æ¡† */
            box-shadow: 0 0 15px rgba(168,58,58,0.7), 2px 2px 0 #8b2b2b;
            border: 2px solid #fbf8f0;
            @apply tracking-widest;
        }

        /* æ•…äº‹å†…å®¹çš„æ’ç‰ˆï¼Œæ¨¡æ‹Ÿå¤ç± */
        .story-content p {
            @apply text-lg leading-relaxed mb-4 text-ink;
        }
        .story-content h2 {
            @apply font-display text-2xl font-bold mb-4 border-b border-ink/30 pb-2;
        }
        
        /* ç« èŠ‚å¯¼èˆªé¡¹çš„æ ·å¼ - æ¢å¤ä¸ºåˆ—è¡¨æ ·å¼ */
        .toc-item {
            @apply p-3 cursor-pointer text-sm font-display text-ink hover:bg-wood-dark/10 transition duration-150 rounded-md flex items-center space-x-2;
        }
        .toc-node {
            @apply w-3 h-3 rounded-full border border-ink;
        }
        .toc-node.active {
            @apply bg-accent-red border-accent-red;
        }
        .toc-node.completed {
            @apply bg-green-600 border-green-600;
        }

        /* éšè—åœ°å›¾æ¨¡æ€æ¡† */
        #map-modal {
            display: none !important;
        }
    </style>
</head>
<body class="bg-wood-dark min-h-screen font-serif flex justify-center items-center py-8 px-4">

    <div id="game-container" class="w-full max-w-6xl h-[90vh] bg-paper shadow-scroll rounded-xl overflow-hidden flex flex-col md:flex-row">

        <div id="story-panel" class="md:w-3/5 w-full h-1/2 md:h-full p-8 overflow-y-auto hide-scrollbar relative">
            
            <button id="back-button" class="absolute top-4 left-4 z-10 gufu-btn px-3 py-1 text-base hidden" onclick="goBack()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                æ•…äº‹å›æº¯
            </button>
            
            <h1 class="text-4xl font-display text-center text-accent-red mb-6 border-b-2 border-accent-red/50 pb-3">
                å¤©ç†åŠ«ï¼šå…´è´¤ä¹¦é™¢è°œæ¡ˆ
            </h1>

            <div id="story-text" class="story-content transition-opacity duration-500">
                </div>

            <div id="interaction-area" class="mt-8 border-t border-ink/20 pt-6">
                </div>
            
            <div id="scene-nav" class="mt-10 flex justify-center space-x-4">
                </div>
        </div>

        <div class="md:w-2/5 w-full h-1/2 md:h-full bg-wood-dark/10 p-6 overflow-y-auto hide-scrollbar flex flex-col space-y-6 border-l border-wood-dark/30">

            <div class="flex justify-between space-x-2 mb-4">
                <button id="toc-toggle" class="gufu-btn flex-1 text-sm px-4 py-2" onclick="toggleSidebar('toc')">ç« èŠ‚å¯¼èˆª</button>
                <button id="history-toggle" class="gufu-btn flex-1 text-sm px-4 py-2 opacity-70" onclick="toggleSidebar('history')">è¡ŒåŠ¨è½¨è¿¹</button>
            </div>

            <div id="sidebar-toc" class="space-y-3">
                <h2 class="text-xl font-display text-ink border-b border-ink/30 pb-2 mb-3">æ•…äº‹åœ°å›¾ï¼ˆæµç¨‹ï¼‰</h2>
                </div>

            <div id="sidebar-history" class="space-y-2 hidden">
                <h2 class="text-xl font-display text-ink border-b border-ink/30 pb-2 mb-3">å†å²è®°å½•</h2>
                <div id="history-list" class="text-sm text-ink/80 space-y-1">
                    <p>æ—…ç¨‹ä¼Šå§‹...</p>
                </div>
            </div>

        </div>

    </div>

<script>
    // --- å…¨å±€å˜é‡ä¸æ¸¸æˆçŠ¶æ€ ---
    let gameData = {};
    let currentScene = 'intro';
    let sceneHistory = [];
    
    // å®šä¹‰æ•…äº‹ä¸»çº¿è·¯å¾„ï¼Œç”¨äºç²¾ç¡®å›æº¯
    const storyPath = [
        'intro',
        'dot1_ritual',
        'dot2_jigsaw',
        'dot4_intro',
        'dot4_coronation',
        'dot5_intro',
        'dot5_fill',
        'dot6_intro',
        'dot6_judgement',
        'dot13_intro',
        'dot13_quiz',
        'final_teaching',
        'epilogue'
    ];
    
    // --- åœºæ™¯æ•°æ®å®šä¹‰ ---
    const scenes = {
        'intro': {
            title: "å¤©ç†åŠ«ï¼šå…´è´¤ä¹¦é™¢è°œæ¡ˆ",
            content: `
                <h2 class="text-center font-display text-2xl font-bold mb-6 text-accent-red">åºç« ï¼šé£é›ªäº”å¤«Â·é“ç»Ÿé£˜é›¶</h2>
                <p><strong>æ•…äº‹èƒŒæ™¯ï¼šï¼š</strong>å—å®‹åº†å…ƒå¹´é—´ï¼Œäº”å¤«å¤é•‡ä¸­çš„å…´è´¤ä¹¦é™¢ï¼Œæ›¾æ˜¯æœ±ç†¹è®²å­¦æˆé“ä¹‹æ‰€ã€‚ç„¶è€Œï¼Œåº†å…ƒäºŒå¹´ï¼Œæœä¸­é£æ³¢éª¤èµ·ï¼Œç†å­¦è¢«æ–¥ä¸ºâ€œä¼ªå­¦â€ï¼Œæœ±å­ä¹‹å­¦é­ä¸¥ç¦ã€‚æ›´è‡´å‘½çš„æ˜¯ï¼Œ æœ±ç†¹ã€Šå››ä¹¦ç« æ³¨ã€‹çš„æ‰‹ç¨¿ï¼Œç«Ÿåœ¨æ··ä¹±ä¸­ç¦»å¥‡å¤±çªƒã€‚</p>
                <p><strong>ä½ æ˜¯è°ï¼šï¼š</strong>ä½ å« <strong>é™ˆè§‚ç†</strong>ï¼Œ25å²ï¼Œå…´è´¤ä¹¦é™¢å­¦å­ï¼Œæ²‰ç€å†·é™ï¼Œå–„äºè§‚å¯Ÿï¼Œæ·±å—æœ±ç†¹å½±å“ã€‚</p>
                <p>ä½ èº«è´Ÿæ©å¸ˆä¿¡å¿µï¼Œæ”¶åˆ°å¯†ä¿¡ï¼Œæ¯…ç„¶è¸å…¥è¿™è¿·å±€ä¹‹ä¸­ã€‚ä½ å¿…é¡»æ‰¾å›è¿™ä»½çè´µçš„æ‰‹ç¨¿ï¼Œæ´—åˆ·æ³¼å‘å¸ˆé—¨çš„æ±¡åï¼Œä¸ºä¹±ä¸–å®ˆä½æœ€åä¸€ç‚¹å…‰æ˜ã€‚</p>
                <p>å¢¨å·æ— å£°ï¼Œæ­£é“å­˜å¿ƒï¼›ä¹¦é™¢æ·±å¤„ï¼Œç­‰ä½ å¯»è¸ªã€‚</p>
            `,
            options: [{ text: "å¯ç¨‹ï¼šå‰å¾€å…´è´¤ä¹¦é™¢", nextScene: 'dot1_ritual' }]
        },
        // ç‚¹ä½1ï¼šç°ªèŠ±ç¥ˆç¦ä»ªå¼
        'dot1_ritual': {
            title: "ç‚¹ä½ä¸€ï¼šç°ªèŠ±ç¥ˆç¦å° (ä»ªå¼å¤åŸ)",
            content: `
                <p>é£é›ªæ¼«äº”å¤«ã€‚å½“ä½ è¸è¿›ç†Ÿæ‚‰çš„å…´è´¤ä¹¦é™¢ï¼Œå¾€æ—¥ä¹¦å£°ç…ç…çš„æ™¯è±¡å·²è¡ç„¶æ— å­˜ã€‚è€ä»†è¿ä¸Šæ¥ï¼Œå£°éŸ³é‡Œå¸¦ç€æƒŠæƒ¶ï¼šâ€œä»–ä»¬ä¸æ­¢çƒ§ä¹¦ï¼Œè¿å­¦å­ä»¬ç¥ˆæ„¿å‰ç¨‹çš„<strong>ç°ªèŠ±ç¥ˆç¦å°</strong>ï¼Œä¹Ÿç»™ç ¸äº†ï¼â€</p>
                <p>ä½ èµ°å‘é‚£ç‰‡ç‹¼è—‰ï¼Œè€ä»†é€’æ¥ä¸€æœ¬ã€Šç°ªèŠ±ä»ªè½¨ã€‹ï¼šâ€œå…¬å­ï¼Œè‹¥èƒ½å¤åŸæ­¤ç¤¼ï¼Œæˆ–èƒ½å”¤é†’ä¹¦é™¢æ­£æ°”ã€‚â€</p>
                <p><strong>è¯·ä¾åºå¤åŸå®‹ä»£å­¦å­è€ƒå‰ä»ªå¼ï¼š</strong> å‡€æ‰‹ç„šé¦™ &rarr; æ–æ‹œå…ˆå¸ˆ &rarr; ç°ªèŠ±äºå†  &rarr; æŠ½ç­¾å¾—è®­ ã€‚</p>
            `,
            render: renderZanhuaRitual,
            nextScene: 'dot2_jigsaw',
            state: { step: 0, stepsComplete: [false, false, false, false], labels: ["å‡€æ‰‹", "ç„šé¦™", "ç°ªèŠ±", "æ–æ‹œå…ˆå¸ˆ"] }
        },
        // ç‚¹ä½2ï¼šæ‹¼å›¾å¤åŸé—¨å›¾
        'dot2_jigsaw': {
            title: "ç‚¹ä½äºŒï¼šé—¨å›¾æ‹¼å›¾ä¸é”çš„çº¿ç´¢",
            content: `
                <p>ä½ å®Œæˆä»ªå¼åï¼Œè€ä»†æ„ŸåŠ¨é“ï¼šâ€œæ˜”å¹´å­¦å­çš†ç”±æ­¤æ˜å¿—ï¼Œä»Šæ—¥é‡ç°ï¼Œæ­£æ°”ä¸ç­ï¼â€</p>
                <p>éšåï¼Œä½ åœ¨ç°ªèŠ±å°é™„è¿‘å‘ç°åœ°ä¸Šæ•£è½ç€ä¸€å¹…è¢«å‰²ç ´çš„<strong>ã€Šå…´è´¤ä¹¦é™¢é—¨å›¾ã€‹</strong>ã€‚ä½ ç»†å¿ƒæ‹¼å¥½ï¼Œç¿»è¿‡æ¥ç«Ÿå‘ç°å…«ä¸ªå¤§å­—ï¼šâ€œæ ¼ç‰©è‡´çŸ¥ï¼Œè¯šæ„æ­£å¿ƒâ€ã€‚</p>
                <p>è€ä»†äººçªç„¶æƒ³èµ·é‚£ä¼™äººç¦»å¼€æ—¶å–Šäº†ä¸€å¥ï¼šâ€œ**æ¸…è²ä¸æŸ“å°˜ï¼Œä¹Œçº±é¡»æ— å¢**â€ã€‚ä½ ä»”ç»†è§‚å¯Ÿé“œé”ï¼Œå‘ç°é”ä¸Šåˆ»æœ‰è²èŠ±å’Œå®˜å¸½çš„å›¾æ¡ˆã€‚</p>
                <p><strong>ä»»åŠ¡ï¼šï¼š</strong>è¯·æ‹¼å›¾å¤åŸé—¨å›¾ï¼Œç„¶åå¯»æ‰¾çº¿ç´¢æ‰“å¼€é“œé”ã€‚</p>
            `,
            render: renderJigsawAndLock,
            nextScene: 'dot4_intro', // ç›´æ¥è·³åˆ°ä¸‹ä¸€åœºæ™¯çš„ä»‹ç»
        },
        // åœºæ™¯è¿‡æ¸¡ï¼šè¿›å…¥è—ä¹¦é˜
        'dot4_intro': {
            title: "ç¬¬ä¸€å¹•ï¼šè—ä¹¦é˜çš„è°œé¢˜",
            content: `
                <h2 class="text-center font-display text-2xl font-bold mb-6 text-accent-red">ç¬¬ä¸€å¹•ï¼šè—ä¹¦é˜çš„è°œé¢˜</h2>
                <p>â€œå’”å—’â€”â€”â€é“œé”å¼¹å¼€ï¼Œä½ è¿ˆè¿‡é—¨æ§›ï¼Œç ´çª—è€Œå…¥çš„å…‰çº¿ç…§äº®äº†æ»¡å®¤ç‹¼è—‰ã€‚å¢™ä¸Šç‚­æ¶‚å¤§å­—ï¼šâ€œä¼ªç¤¼å½“ç„š!â€</p>
                <p>åœ¨ç‹¼è—‰ä¸­ï¼Œä½ å‘ç°ä¸€ä¸ªæœªè¢«ç ´æŸçš„ç¤¼å™¨ç›’ï¼Œé‡Œé¢ç››æ”¾ç€ä¸¾è¡Œæˆäººç¤¼æ‰€éœ€çš„å™¨ç‰©ï¼Œä½†ç¤¼å™¨æ—çš„ä»ªè½¨å›¾è¢«æ’•æ¯ï¼Œé¡ºåºæ··ä¹±ã€‚</p>
            `,
            options: [{ text: "å¤åŸæˆäººç¤¼ä»ªè½¨", nextScene: 'dot4_coronation' }]
        },
        // ç‚¹ä½4ï¼šæˆäººç¤¼ä»ªå¼
        'dot4_coronation': {
            title: "ç‚¹ä½å››ï¼šæˆäººç¤¼å¤åŸï¼ˆä¸‰åŠ ä¹‹ç¤¼ä¸èµå­—ï¼‰",
            content: `
                <p>è€ä»†å¹æ¯ï¼šâ€œä»–ä»¬è¿æˆäººä¹‹ç¤¼éƒ½è¦è·µè¸ï¼â€ä½ å†³å®šå¤åŸä»ªè½¨ï¼Œä»ç¤¼å™¨ä¸­æ‰¾åˆ°ä¸‹ä¸€æ­¥çš„çº¿ç´¢ã€‚</p>
                <p><strong>ä»»åŠ¡ï¼šï¼š</strong>è¯·å…ˆé€‰æ‹©èº«ä»½ï¼Œç„¶åå°†â€œä¸‰åŠ ä¹‹ç¤¼â€çš„ä¸‰ä¸ªé˜¶æ®µæ­£ç¡®æ’åºã€‚</p>
            `,
            render: renderCoronationRitual,
            nextScene: 'dot5_intro', // è¿›å…¥ä¸‹ä¸€åœºæ™¯ä»‹ç»
            state: { identity: null, currentStep: 0, ceremonyDone: false, isSorting: false, sequence: [], wordChosen: null }
        },
        // åœºæ™¯è¿‡æ¸¡ï¼šè¿›å…¥åˆ˜æ°å®¶ç¥ 
        'dot5_intro': {
            title: "ç¬¬äºŒå¹•ï¼šåˆ˜æ°å®¶ç¥ çš„è€ƒéªŒ",
            content: `
                <h2 class="text-center font-display text-2xl font-bold mb-6 text-accent-red">ç¬¬äºŒå¹•ï¼šåˆ˜æ°å®¶ç¥ çš„è€ƒéªŒ</h2>
                <p>ä½ å¾ªç€çº¿ç´¢æ¥åˆ°åˆ˜æ°å®¶ç¥ ï¼Œåˆ˜è€æ­£åœ¨ç»™å­©ç«¥ä»¬è®²**â€œæœ±å­æ‰˜å­¤â€**çš„æ•…äº‹ã€‚ä»–é€’ç»™ä½ ä¸€æ”¯æ¯›ç¬”ï¼Œè®©ä½ è¡¥å…¨çº¸ä¸Šè¢«è™«è›€æ‰çš„å…³é”®åå­—ã€‚</p>
                <p>æ³›é»„çš„çº¸ä¸Šå†™ç€ï¼šâ€œç»å…´åä¸‰å¹´ï¼Œæœ±æ¾å…¬ç—…ç¬ƒå»ºå®‰ï¼Œæ‰˜å­¤äºæŒšå‹â–ˆã€‚æœ±ç†¹æ—¶å¹´åå››ï¼Œâ–ˆç­‘å®¤ç´«é˜³æºªç•”ï¼Œäº²æˆã€Šè®ºè¯­ã€‹å¤§ä¹‰â€¦â€ ä»…å­˜çš„åŠä¸ª â€œç¾½â€ å­—åœ¨çº¸ç¼˜æ‘‡æ›³ã€‚</p>
            `,
            options: [{ text: "è¡¥å…¨æ‰˜å­¤è€…ä¹‹å", nextScene: 'dot5_fill' }]
        },
        // ç‚¹ä½5ï¼šè¡¥å…¨åå­—
        'dot5_fill': {
            title: "ç‚¹ä½äº”ï¼šè¡¥å…¨æ‰˜å­¤è€…ä¹‹å",
            content: `
                <p><strong>ä»»åŠ¡ï¼šï¼š</strong>æ ¹æ®åˆ˜æ°ä¸€æ—å››ä½æ˜¾èµ«å…ˆäººï¼ˆåˆ˜éŸå…¬ã€åˆ˜å­ç¾½å…¬ã€åˆ˜å­ç¿šå…¬ã€åˆ˜ç™å…¬ï¼‰å’Œâ€œç­‘å®¤ç´«é˜³â€çš„å…¸æ•…ï¼Œé€‰æ‹©æ­£ç¡®çš„äººç‰©åå­—è¡¥å…¨æ•…äº‹ã€‚</p>
            `,
            render: renderLiuFamilyTest,
            nextScene: 'dot6_intro'
        },
        // åœºæ™¯è¿‡æ¸¡ï¼šè¿›å…¥ç¤¾ä»“
        'dot6_intro': {
            title: "ç¬¬ä¸‰å¹•ï¼šç¤¾ä»“è¾¨çœŸå‡",
            content: `
                <h2 class="text-center font-display text-2xl font-bold mb-6 text-accent-red">ç¬¬ä¸‰å¹•ï¼šç¤¾ä»“è¾¨çœŸå‡</h2>
                <p>è€ä»†æ€¥åŒ†åŒ†é—¯è¿›ç¥ å ‚ï¼šâ€œå…¬å­ï¼ä»–ä»¬å»**ç¤¾ä»“**äº†ï¼æ±¡è”‘å…ˆç”Ÿå€Ÿç¤¾ä»“ç‰Ÿåˆ©ï¼â€</p>
                <p>ä½ ç«‹åˆ»å‰å¾€æœ±å­ç¤¾ä»“ã€‚å‡ åå€¼å®ˆå¼Ÿå­æ­£æ‰‹å¿™è„šä¹±ï¼Œä¸€æœ¬è¢«ç¯¡æ”¹çš„ã€Šè´·ç²®ç°¿ã€‹æ··åœ¨å…¶ä¸­ï¼Œè¯¯å¯¼äº†ä»–ä»¬çš„åˆ¤æ–­ã€‚</p>
            `,
            options: [{ text: "è£å†³ç¤¾ä»“å†¤æ¡ˆ", nextScene: 'dot6_judgement' }]
        },
        // ç‚¹ä½6ï¼šç¤¾ä»“è£å†³
        'dot6_judgement': {
            title: "ç‚¹ä½å…­ï¼šç¤¾ä»“è¾¨çœŸå‡ï¼ˆè£å†³ä¸‰æ¡ˆï¼‰",
            content: `
                <p><strong>ä»»åŠ¡ï¼š</strong>ä½ é¢å‰æ‘Šå¼€ç€ã€Šç¤¾ä»“æ‰‹å†Œã€‹ã€‚è¯·æ ¹æ®æ‰‹å†Œçš„ä»ä¹‰åŸåˆ™ï¼Œå¯¹ä¸‰ä¸ªæ¡ˆä¾‹åšå‡ºå…¬æ­£çš„è£å†³ã€‚</p>
            `,
            render: renderShecangJudgement,
            nextScene: 'dot13_intro',
            state: { currentCase: 0, cases: [
                { statement: "ä»Šå¹´å¤§æ—±ï¼Œè€å†œå€Ÿä¸€çŸ³ç±³ï¼Œå€¼å®ˆå¼Ÿå­è¦æ±‚è¿˜ä¸€çŸ³ä¸‰å‡ã€‚", correct: 'false', rule: "è’å¹´èµˆæµä¸ºæœ¬ï¼Œæ¯ç±³çš†å…ã€‚" },
                { statement: "ä¸°å¹´ä½ƒæˆ·æ¥å½’è¿˜å€Ÿç±³ï¼Œå€¼å®ˆå¼Ÿå­è¦æ±‚è¿æœ¬å¸¦åˆ©å…±è¿˜ä¸‰çŸ³ç±³ã€‚", correct: 'false', rule: "ä¸°å¹´å–æ¯æœ‰åº¦ï¼Œä¸ä¸ºç›˜å‰¥ï¼Œåˆ©æ¯ä¸å¾—è¶…è¿‡ä¸€æˆäº”ã€‚" },
                { statement: "å¹³å¹´å¯¡å¦‡æ— åŠ›å¿è¿˜å»å¹´ç²®æ¬¾ï¼Œå€¼å®ˆå¼Ÿå­åšæŒä»Šæ—¥å¿…é¡»è¿˜æ¸…ã€‚", correct: 'false', rule: "é³å¯¡å­¤ç‹¬è€…å…è€—ï¼Œæ›´åº”é…Œæƒ…å»¶æœŸæˆ–å‡å…ã€‚" }
            ]}
        },
        // åœºæ™¯è¿‡æ¸¡ï¼šè¿›å…¥äº”å£äº•
        'dot13_intro': {
            title: "ç¬¬å››ç« ï¼šèƒ¡æ°äº”è´¤äº•",
            content: `
                <h2 class="text-center font-display text-2xl font-bold mb-6 text-accent-red">ç¬¬å››ç« ï¼šèƒ¡æ°äº”è´¤äº•</h2>
                <p>ä½ å‘ç°äº†ç¤¾ä»“å¤¹å±‚ä¸­çš„å¯†ä¿¡ï¼Œä»¥åŠæ¢ä¸ŠèŸ é¾™é›•é¥°çš„ç£é’ˆæŒ‡å¼•ï¼š<strong>â€œäº¥æ—¶ä¸‰åˆ»äº•ç•”ä¼šï¼Œé¾™ç›å¼€å¤„è§å¤©æœºã€‚â€</strong> ç£é’ˆæŒ‡å‘ä¸œåŒ—æ–¹ï¼äº”å¤«é•‡äº•ç¾¤å¯†å¸ƒï¼Œä½ å†³å®šå‰å¾€æŸ¥çœ‹ã€‚</p>
                <p>ä½ æ¥åˆ°ä¸‰å¸‚è¡—ï¼Œå¼€å§‹å¯»æ‰¾äº”å£å¤äº•ã€‚åœ¨æ¢è®¿äº†èƒ¡å®‰å›½ã€èƒ¡å®ªã€èƒ¡å®ã€èƒ¡å¯…å››å£äº•åï¼Œä½ ç»ˆäºæ¥åˆ°äº†ç¬¬äº”å£äº•ã€‚</p>
            `,
            options: [{ text: "ç ´è§£äº”å£äº•çš„é’¥åŒ™", nextScene: 'dot13_quiz' }]
        },
        // ç‚¹ä½13ï¼šäº”å£äº•çš„é’¥åŒ™
        'dot13_quiz': {
            title: "ç‚¹ä½åä¸‰ï¼šäº”å£äº•çš„é’¥åŒ™ï¼ˆä¼ æ‰¿é—®ç­”ï¼‰",
            content: `
                <p>ä½ æ‰¾åˆ°äº†ç¬¬äº”å£äº•ä¸‹çš„å®ç®±ï¼ä½†äº•è¾¹çš„çŸ³ç¯ä¸Šåˆ»ç€ä¸€é“è°œé¢˜ï¼Œå”¯æœ‰ç†è„‰ç›¸é€šè€…æ–¹å¯å¼€å¯ã€‚</p>
            `,
            render: renderWellQuiz,
            nextScene: 'final_teaching',
            state: { answered: false }
        },
        // æœ€ç»ˆç« ï¼šç†å¿ƒé—®é“
        'final_teaching': {
            title: "æœ€ç»ˆç« ï¼šç†å¿ƒé—®é“ (æœ±å­å··)",
            content: `
                <h2 class="text-center font-display text-2xl font-bold mb-6 text-accent-red">æœ€ç»ˆç« ï¼šç†å¿ƒé—®é“ (æœ±å­å··)</h2>
                <p>ä½ å¸¦ç€ã€Šå››ä¹¦ç« æ³¨ã€‹æ‰‹ç¨¿ï¼Œè¸å…¥äº†å†ç†Ÿæ‚‰ä¸è¿‡çš„**æœ±å­å··**ã€‚å‰æ–¹ï¼Œæ©å¸ˆæœ±ç†¹çš„èº«å½±ç¼“ç¼“æµ®ç°ã€‚</p>
                <p>â€œè§‚ç†ï¼Œâ€å…ˆç”Ÿçš„å£°éŸ³å¹³é™è€Œæœ‰åŠ›ï¼Œâ€œä½ ä¸€è·¯å†ç» è¾¨ä¼ªã€æµæ°‘ã€å¯»çœŸï¼Œå¯çŸ¥ ç†åœ¨ä½•å¤„ï¼Ÿâ€</p>
                <p>ä½ å›ç­”ï¼šâ€œå›å…ˆç”Ÿï¼Œç†åœ¨ä¹¦ä¸­ï¼Œä¹Ÿåœ¨äººå¿ƒã€‚â€</p>
                <p>å…ˆç”Ÿé¢”é¦–ï¼Œå¹¶å‘ä½ æŠ›å‡ºäº†ä¸‰æƒ‘ï¼šåŒå­¦è®¥ç¬‘ã€ä¿—åŠ¡çº·æ‚ã€é™åæ‚å¿µã€‚ä½ å°†å¦‚ä½•é€‰æ‹©ï¼Œä»¥æ›´å¥½åœ°ç†è§£å…ˆç”Ÿçš„æ•™å¯¼ï¼Ÿ</p>
            `,
            render: renderFinalTeachings,
            nextScene: 'epilogue',
            state: { currentQuestion: 0, score: 0, questions: [
                { prompt: "åº”å¯¹çäº‹çº·æ‰°ï¼šæ€»æ˜¯è§‰å¾—æ—¥å¸¸çäº‹æ‰“æ‰°äº†é‡è¦çš„æ­£äº‹ï¼Œåœ¨ä¸åŒä»»åŠ¡é—´åˆ‡æ¢ï¼Œæ•ˆç‡å¾ˆä½ï¼Œæ„Ÿåˆ°éå¸¸ç„¦è™‘ã€‚ä¾å°”ä¹‹è§ï¼Œå½“å¦‚ä½•ç ´æ­¤å›°å±€ï¼Ÿ", options: ["è¿œç¦»å°˜åš£ï¼Œé¿ä¸–è¯»ä¹¦ã€‚", "å°†æ¯ä»¶çäº‹è§†ä¸ºç£¨ç»ƒä¸“æ³¨åŠ›çš„æœºä¼šï¼Œåšäº‹æ—¶å¿ƒæ— æ—éª›ï¼Œåšå®Œåè¿…é€Ÿå›å½’ä¸»çº¿ã€‚", "ç´¢æ€§æ”¾ä¸‹ä¸€åˆ‡ï¼Œå°½æƒ…æ”¾æ¾ï¼Œå¾…å¿ƒæƒ…å¥½è½¬å†å¤„ç†ã€‚"], correctIndex: 1, explanation: "å–„ï¼â€˜äº‹ä¸Šç£¨å¿ƒï¼Œä¸“æ³¨å³è½¬æ¢ã€‚â€™æ­¤ä¹ƒå­¦ä»¥è‡´ç”¨ã€çŸ¥è¡Œåˆä¸€ä¹‹çœŸè°›ã€‚" },
                { prompt: "åº”å¯¹å†…å¿ƒæ‚å¿µï¼šæˆ‘ä¸€é™ä¸‹æ¥å°±èƒ¡æ€ä¹±æƒ³ï¼Œè¶Šæ˜¯æƒ³ä¸“æ³¨ï¼Œå†…å¿ƒè¶Šæ˜¯çƒ¦èºï¼Œæ ¹æœ¬æ— æ³•å¹³é™ã€‚æ­¤æ—¶ä½ å½“å¦‚ä½•æ”¶å¿ƒï¼Ÿ", options: ["åŠªåŠ›å‹åˆ¶æ¯ä¸€ä¸ªå¿µå¤´ï¼Œç›´åˆ°å¤§è„‘ä¸€ç‰‡ç©ºç™½ã€‚", "æ”¾ä»»æ€ç»ªæµæ·Œï¼Œæƒ³ç´¯äº†è‡ªç„¶å°±åœäº†ã€‚", "ä¸å»å¯¹æŠ—æ‚å¿µï¼Œè€Œæ˜¯ä¸“æ³¨äºè°ƒæ•´å‘¼å¸ï¼Œå¦‚åŒæèµ·è¡£é¢†ï¼Œå¿ƒè™šè‡ªä¼šå¹³é¡ºã€‚", "åªå»å¯¹æŠ—æ‚å¿µï¼Œä¸è°ƒæ•´å‘¼å¸"], correctIndex: 2, explanation: "ç„¶ä¹Ÿï¼â€˜å¿ƒå¦‚è¡£é¢†ï¼Œä¸€æåˆ™é¡ºã€‚â€™é™åéä¸ºæ¯å®ˆï¼Œä¹ƒæ˜¯å”¤é†’å†…å¿ƒçš„è§‰çŸ¥ä¸ä¸»å®°ã€‚" }
            ]}
        },
        // ç»“å±€
        'epilogue': {
            title: "ç»“å±€ï¼šä¹¦é™¢é‡ç°å…‰æ˜",
            content: `
                <h2 class="text-center font-display text-2xl font-bold mb-6 text-accent-red">ç»“å±€ï¼šä¹¦é™¢é‡ç°å…‰æ˜</h2>
                <p>æœ±ç†¹å…ˆç”Ÿèµ è¨€ï¼šâ€œä¸–è™½ä¸‡å˜ï¼Œç„¶æœ‰ä¸‰äº‹ä¸å¯ç§»ï¼šä¸€æ›°ç«‹å¿—ï¼ŒäºŒæ›°æŒæ•¬ï¼Œä¸‰æ›°æ¸è¿›ã€‚æ­¤æ‰‹ç¨¿èµ äºˆä½ ï¼Œä¼ äºåä¸–ã€‚â€</p>
                <p>ä½ æ€€æ£æ‰‹ç¨¿é‡è¿”ä¹¦é™¢ï¼Œè§å­©ç«¥å·²åœ¨è¯µè¯»ã€Šå››ä¹¦ç« æ³¨ã€‹ï¼Œè€ä»†å«ç¬‘ç›¸è¿ã€‚</p>
                <p>æ‰‹ç¨¿å½’ä½ï¼Œä¹¦é™¢é‡ç°å…‰æ˜ã€‚</p>
                <p>ä½ ç«‹äºç°ªèŠ±å°å‰ï¼Œè½»å£°é“ï¼šâ€œåŒçª—è®¥ç¬‘ä¹ƒç£¨å¿—ä¹‹çŸ³ï¼Œä¿—åŠ¡çº·æ‚ä¹ƒç‚¼å¿ƒä¹‹ç«ï¼Œé™åæ‚å¿µä¹ƒç…§å¦„ä¹‹é•œï¼æ„¿æŒæ­¤ä¸‰å¢ƒï¼Œä¼ ç†äºåä¸–ã€‚â€</p>
                <div class="mt-8 text-center text-xl font-display text-accent-red border-t border-accent-red/50 pt-4">
                    ğŸ‰ æ­å–œä½ ï¼Œå®Œæˆäº†ã€Šå¤©ç†åŠ«ï¼šå…´è´¤ä¹¦é™¢è°œæ¡ˆã€‹ï¼
                </div>
            `,
            options: []
        }
    };
    
    // ç« èŠ‚å¯¼èˆªæ•°æ® (æŒ‡å‘å„å¹•çš„èµ·å§‹é¡µ)
    const tocData = [
        { id: 'intro', title: 'åºç« ï¼šé£é›ªäº”å¤«' },
        { id: 'dot4_intro', title: 'ç¬¬ä¸€å¹•ï¼šè—ä¹¦é˜çš„è°œé¢˜' },
        { id: 'dot5_intro', title: 'ç¬¬äºŒå¹•ï¼šåˆ˜æ°å®¶ç¥ çš„è€ƒéªŒ' },
        { id: 'dot6_intro', title: 'ç¬¬ä¸‰å¹•ï¼šç¤¾ä»“è¾¨çœŸå‡' },
        { id: 'dot13_intro', title: 'ç¬¬å››ç« ï¼šèƒ¡æ°äº”è´¤äº•' },
        { id: 'final_teaching', title: 'æœ€ç»ˆç« ï¼šç†å¿ƒé—®é“' },
        { id: 'epilogue', title: 'ç»“å±€ï¼šä¹¦é™¢é‡ç°å…‰æ˜' }
    ];
    
    // åœ°å›¾èŠ‚ç‚¹æ•°æ® (ç”¨äºè™šæ‹Ÿåœ°å›¾) - æ­¤æ•°æ®ä»…ç”¨äºæµç¨‹åœ°å›¾å±•ç¤ºï¼Œä¸å†ç”¨äºå¤æ‚çš„SVGå®šä½
    const mapNodes = [
        { id: 'intro', title: 'å…´è´¤ä¹¦é™¢ (èµ·å§‹)', scene: 'intro', chapter: 0 },
        { id: 'dot4_intro', title: 'è—ä¹¦é˜ (è°œé¢˜)', scene: 'dot4_intro', chapter: 1 },
        { id: 'dot5_intro', title: 'åˆ˜æ°å®¶ç¥  (è€ƒéªŒ)', scene: 'dot5_intro', chapter: 2 },
        { id: 'dot6_intro', title: 'æœ±å­ç¤¾ä»“ (è¾¨çœŸå‡)', scene: 'dot6_intro', chapter: 3 },
        { id: 'dot13_intro', title: 'èƒ¡æ°äº”è´¤äº• (å¯»è¸ª)', scene: 'dot13_intro', chapter: 4 },
        { id: 'final_teaching', title: 'æœ±å­å·· (é—®é“/ç»ˆç« )', scene: 'final_teaching', chapter: 5 },
        { id: 'epilogue', title: 'ç»“å±€ (å›é¡¾)', scene: 'epilogue', chapter: 6 }
    ];


    // --- æ ¸å¿ƒå‡½æ•° ---

    /**
     * åˆå§‹åŒ–æ¸¸æˆ
     */
    function initGame() {
        const storedHistory = localStorage.getItem('mysteryBookHistory');
        const storedScene = localStorage.getItem('mysteryBookScene');

        // åˆå§‹åŒ–åœºæ™¯å†å²
        if (storedHistory) {
            sceneHistory = JSON.parse(storedHistory);
            // é‡æ–°æ¸²æŸ“å†å²åˆ—è¡¨
            renderHistory(); 
        } else {
            sceneHistory = [];
        }

        // åˆå§‹åŒ–å½“å‰åœºæ™¯
        if (storedScene && scenes[storedScene]) {
             // å¦‚æœå­˜å‚¨çš„åœºæ™¯æœ‰æ•ˆï¼Œåˆ™è·³è½¬
            currentScene = storedScene;
            renderScene(currentScene, false);
        } else {
            // å¦åˆ™ä»å¤´å¼€å§‹
            setNextScene('intro');
        }
        
        // æ¸²æŸ“ç›®å½•
        renderTOC();

        // ç»‘å®šåˆ‡æ¢äº‹ä»¶
        // é‡æ–°è·å– toc-toggle å…ƒç´ 
        document.getElementById('toc-toggle').addEventListener('click', () => toggleSidebar('toc'));
        document.getElementById('history-toggle').addEventListener('click', () => toggleSidebar('history'));
    }

    /**
     * æ¸²æŸ“å½“å‰åœºæ™¯
     * @param {string} sceneId - åœºæ™¯ID
     * @param {boolean} record - æ˜¯å¦è®°å½•åˆ°å†å² (å›æº¯æ—¶ä¸éœ€è¦è®°å½•)
     */
    function renderScene(sceneId, record = true) {
        const scene = scenes[sceneId];
        const storyText = document.getElementById('story-text');
        const interactionArea = document.getElementById('interaction-area');
        const sceneNav = document.getElementById('scene-nav');
        const backButton = document.getElementById('back-button');

        // 1. è®°å½•å†å² (ä»…ç”¨äº"è¡ŒåŠ¨è½¨è¿¹"é¢æ¿)
        if (record && currentScene !== sceneId) {
            // æ³¨æ„ï¼šè¿™é‡Œåªè®°å½•åˆ° sceneHistoryï¼Œä¸å†ç”¨äº goBack é€»è¾‘
            sceneHistory.push(currentScene);
            renderHistory();
        }
        currentScene = sceneId;
        localStorage.setItem('mysteryBookScene', currentScene);
        localStorage.setItem('mysteryBookHistory', JSON.stringify(sceneHistory));

        // 2. æ¸²æŸ“åŸºç¡€å†…å®¹
        storyText.innerHTML = scene.content;
        interactionArea.innerHTML = '';
        sceneNav.innerHTML = '';

        // 3. æ¸²æŸ“è°œé¢˜/äº’åŠ¨åŒº
        if (scene.render) {
            scene.render();
        }

        // 4. æ¸²æŸ“å¯¼èˆªæŒ‰é’® (å¦‚æœè°œé¢˜æœªæ¸²æŸ“ï¼Œåˆ™æ˜¾ç¤ºæ™®é€šå¯¼èˆª)
        // æ³¨æ„ï¼šç‚¹ä½1 (dot1_ritual) çš„ä¸‹ä¸€æ­¥æŒ‰é’®ç”±è°œé¢˜å‡½æ•°è´Ÿè´£æ¸²æŸ“
        if (!scene.render || (interactionArea.innerHTML === '' && sceneId !== 'dot1_ritual')) {
            if (scene.options) {
                scene.options.forEach(option => {
                    const button = document.createElement('button');
                    // åº”ç”¨ä¸»çº¿æ¨è¿›æ ·å¼
                    button.className = 'gufu-btn gufu-btn-primary'; 
                    button.textContent = option.text;
                    button.onclick = () => setNextScene(option.nextScene);
                    sceneNav.appendChild(button);
                });
            }
        }
        
        // 5. æ¸²æŸ“å›æº¯æŒ‰é’®
        const currentIndex = storyPath.indexOf(currentScene);
        if (currentIndex > 0) {
            backButton.classList.remove('hidden');
        } else {
            backButton.classList.add('hidden');
        }
        
        // 6. æ ‡è®° TOC ä¸­çš„å½“å‰ç‚¹
        renderTOC(); // æ¯æ¬¡åœºæ™¯å˜åŒ–éƒ½æ›´æ–°å¯¼èˆªçŠ¶æ€
    }
    
    /**
     * è®¾ç½®å¹¶æ¸²æŸ“ä¸‹ä¸€ä¸ªåœºæ™¯
     * @param {string} sceneId - ä¸‹ä¸€ä¸ªåœºæ™¯ID
     */
    function setNextScene(sceneId) {
        // åœºæ™¯è·³è½¬å‰ï¼Œæ¸…ç©ºäº’åŠ¨åŒºï¼Œé¿å…æ®‹ç•™çŠ¶æ€å½±å“ä¸‹ä¸€ä¸ªåœºæ™¯
        document.getElementById('interaction-area').innerHTML = ''; 
        renderScene(sceneId, true);
    }
    
    /**
     * **æ–°é€»è¾‘ï¼š** æŒ‰ç…§æ•…äº‹ä¸»çº¿è·¯å¾„å›æº¯ã€‚
     */
    window.goBack = () => {
        const currentIndex = storyPath.indexOf(currentScene);

        if (currentIndex > 0) {
            const lastMajorScene = storyPath[currentIndex - 1];
            
            // é‡å»º sceneHistory åˆ°ä¸Šä¸€ä¸ªä¸»çº¿ç‚¹
            sceneHistory = storyPath.slice(0, currentIndex - 1);
            renderHistory();

            // è·³è½¬åˆ°ä¸Šä¸€ä¸ªä¸»çº¿åœºæ™¯ (ä¸è®°å½•å†å²)
            renderScene(lastMajorScene, false); 
        }
    }
    
    /**
     * æ¸²æŸ“ä¾§è¾¹æ çš„å†å²è®°å½•
     */
    function renderHistory() {
        const historyList = document.getElementById('history-list');
        historyList.innerHTML = '';
        if (sceneHistory.length === 0) {
            historyList.innerHTML = '<p class="text-ink/60">æ—…ç¨‹ä¼Šå§‹...</p>';
            return;
        }
        
        // å€’åºæ˜¾ç¤ºï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šé¢
        [...sceneHistory].reverse().forEach((sceneId, index) => {
            const sceneTitle = scenes[sceneId]?.title || sceneId;
            const li = document.createElement('p');
            li.className = 'text-sm text-ink/80 border-b border-ink/10 pb-1';
            li.textContent = `[${sceneHistory.length - index}] ${sceneTitle}`;
            historyList.appendChild(li);
        });
    }
    
    /**
     * æ¸²æŸ“ä¾§è¾¹æ çš„ç« èŠ‚å¯¼èˆª (TOC) - æ¢å¤ä¸ºæµç¨‹å›¾å¼çš„æ–‡å­—å¯¼èˆª
     */
    function renderTOC() {
        const tocContainer = document.getElementById('sidebar-toc');
        let html = '<h2 class="text-xl font-display text-ink border-b border-ink/30 pb-2 mb-3">æ•…äº‹åœ°å›¾ï¼ˆæµç¨‹ï¼‰</h2><div class="space-y-2">';

        const currentPathIndex = storyPath.indexOf(currentScene);

        mapNodes.forEach(node => {
            const nodeIndex = storyPath.indexOf(node.scene);
            const isCurrent = node.scene === currentScene || (nodeIndex !== -1 && currentPathIndex >= nodeIndex && currentPathIndex < storyPath.indexOf(mapNodes[mapNodes.indexOf(node) + 1]?.scene || 'epilogue'));
            const isCompleted = nodeIndex < currentPathIndex;
            const statusClass = isCurrent ? 'bg-accent-red active' : (isCompleted ? 'bg-green-600 completed' : 'bg-paper');

            html += `
                <div class="toc-item ${isCurrent ? 'bg-accent-red/20 font-bold' : ''}" 
                     data-scene="${node.scene}"
                     onclick="jumpToScene('${node.scene}')">
                    <span class="toc-node ${statusClass}"></span>
                    <span>${node.title}</span>
                </div>
            `;
        });

        html += '</div>';
        tocContainer.innerHTML = html;
    }
    
    /**
     * **æ–°é€»è¾‘ï¼š** è·³è½¬åˆ°æŒ‡å®šåœºæ™¯ (ä¼šæ¸…ç©ºå¹¶é‡å»ºä¸»çº¿å†å²)
     * @param {string} sceneId - ç›®æ ‡åœºæ™¯ID
     */
    window.jumpToScene = (sceneId) => {
        if (sceneId === currentScene) return;
        
        const targetIndex = storyPath.indexOf(sceneId);
        
        if (targetIndex !== -1) {
            // å°†å†å²è®¾ç½®ä¸ºä» intro åˆ°ç›®æ ‡åœºæ™¯ä¹‹é—´çš„æ‰€æœ‰ä¸»çº¿åœºæ™¯
            sceneHistory = storyPath.slice(0, targetIndex); 
        } else {
            // å¦‚æœç›®æ ‡åœºæ™¯ä¸åœ¨ä¸»çº¿è·¯å¾„ä¸Š (ç†è®ºä¸Šä¸åº”è¯¥å‘ç”Ÿ)ï¼Œåˆ™æ¸…ç©ºå†å²
            sceneHistory = [];
        }
        
        renderHistory();
        
        // æ¸²æŸ“ç›®æ ‡åœºæ™¯ (ä¸è®°å½•å†å²ï¼Œå› ä¸º history å·²ç»è¢«æ‰‹åŠ¨è®¾ç½®)
        renderScene(sceneId, false);
        
        toggleSidebar('toc'); 
        
    }
    
    /**
     * åˆ‡æ¢ä¾§è¾¹æ è§†å›¾ (TOCæˆ–History)
     * @param {string} view - 'toc' æˆ– 'history'
     */
    function toggleSidebar(view) {
        const toc = document.getElementById('sidebar-toc');
        const history = document.getElementById('sidebar-history');
        const tocToggle = document.getElementById('toc-toggle');
        const historyToggle = document.getElementById('history-toggle');

        if (view === 'toc') {
            toc.classList.remove('hidden');
            history.classList.add('hidden');
            tocToggle.classList.add('opacity-100');
            historyToggle.classList.remove('opacity-100');
            renderTOC(); // ç¡®ä¿TOCçŠ¶æ€æ˜¯æœ€æ–°çš„
        } else {
            toc.classList.add('hidden');
            history.classList.remove('hidden');
            tocToggle.classList.remove('opacity-100');
            historyToggle.classList.add('opacity-100');
            renderHistory(); // ç¡®ä¿å†å²è®°å½•æ˜¯æœ€æ–°çš„
        }
    }
    
    // èµå­—æ•°æ®
    const wordOptions = {
        "ä¿®èº«å¿ƒæ€§ç±»": [
            { word: "æ•¬æ–‹", desc: "å±…å¤„æ­ï¼Œæ‰§äº‹æ•¬ï¼Œä»¥å†…ç›´å¤–ï¼Œæ˜¯è°“æ•¬æ–‹ã€‚â€”â€”æ•¬å­—å·¥å¤«ï¼Œä¹ƒæ˜¯åœ£é—¨ç¬¬ä¸€ä¹‰ã€‚" },
            { word: "è¯šæ˜", desc: "ç”±çœŸè¯šè€Œæ˜å–„å¾·ï¼Œå› æ˜å¾·è€Œè¾¾è‡³è¯šã€‚â€”â€”è¯šåˆ™æ˜çŸ£ï¼Œæ˜åˆ™è¯šçŸ£ã€‚" },
            { word: "æ¶µç”«", desc: "æ¶µå…»æ­¤å¿ƒï¼Œé¡»ç”¨æ•¬ä¹‹åŠŸå¤«ï¼Œå¦‚æ°´ä¹‹æ·±è“„ã€‚â€”â€”æ¶µå…»é¡»ç”¨æ•¬ï¼Œè¿›å­¦åˆ™åœ¨è‡´çŸ¥ã€‚" },
            { word: "æ…ç‹¬", desc: "äººæ‰€ä¸çŸ¥è€Œå·²æ‰€ç‹¬çŸ¥ä¹‹åœ°ï¼Œå°¤å½“è°¨æ…ã€‚â€”â€”å›å­æ…å…¶ç‹¬ä¹Ÿã€‚" },
        ],
        "å®‡å®™æœ¬ä½“ç±»": [
            { word: "ç†åˆ", desc: "ç©·ç©¶ä¸‡åŒ–ä¹‹åˆå§‹ï¼Œè«ä¸æœ‰ç†ã€‚â€”â€”ç†åœ¨æ°”å…ˆã€‚" },
            { word: "å¤ªæ", desc: "æ€»å¤©åœ°ä¸‡ç‰©ä¹‹ç†ï¼Œä¾¿æ˜¯å¤ªæã€‚â€”â€”å¤ªæåªæ˜¯ä¸€ä¸ªç†å­—ã€‚" },
            { word: "é“åŸ", desc: "é“ä¸ºç†ä¹‹ç»Ÿåï¼Œæ¢å…¶æœ¬æºï¼Œæ–¹å¾—ç©¶ç«Ÿã€‚â€”â€”é“å³ç†ä¹‹è°“ä¹Ÿã€‚" },
            { word: "æ€§å¤©", desc: "æ€§å³ç†ä¹Ÿï¼Œå…¶æ‰€ä»æ¥ï¼Œæºäºå¤©å‘½ã€‚â€”â€”æ€§ä¹ƒå¤©æ‰€å‘½ï¼Œç†ä¹‹æ‰€åœ¨ã€‚" },
        ],
        "ä¸ºå­¦ä¹‹é“ç±»": [
            { word: "æ ¼åºµ", desc: "äºä¹¦æ–‹ä¸­æ ¼ä¸‡ç‰©ä¹‹ç†ï¼Œåœ¨äº‹ä¸ºä¸Šè‡´æœ¬å¿ƒä¹‹çŸ¥ã€‚â€”â€”æ ¼ç‰©è‡´çŸ¥ã€‚" },
            { word: "ç©·ç†", desc: "å³ç‰©è€Œç©·å…¶ç†ï¼Œä»¥æ±‚è‡³ä¹å…¶æã€‚â€”â€”æ‰€è°“è‡´çŸ¥åœ¨æ ¼ç‰©è€…ï¼Œè¨€æ¬²è‡´å¾ä¹‹çŸ¥ï¼Œåœ¨å³ç‰©è€Œç©·å…¶ç†ä¹Ÿã€‚" },
            { word: "çŸ¥æœ¬", desc: "çŸ¥æ‰€å…ˆåï¼Œåˆ™è¿‘é“çŸ£ã€‚ä¸‡äº‹é¡»ä»æ ¹æœ¬ç†ä¼šã€‚â€”â€”åŠ¡æœ¬åŠ›è¡Œï¼Œä»¥æ¸è€Œè¿›ã€‚" },
            { word: "è´¯ä¸€", desc: "æ•£äºä¸‡ç‰©ä¹‹ç†ï¼Œç”±ä¸€ä»¥è´¯ä¹‹ã€‚â€”â€”ä¸€ä»¥è´¯ä¹‹ã€‚" },
        ],
        "ç†æƒ³å¢ƒç•Œç±»": [
            { word: "å¸Œè´¤", desc: "å£«å¸Œè´¤ï¼Œè´¤å¸Œåœ£ï¼Œå¿ƒå­˜é«˜è¿œï¼Œæ­¥å±¥åšå®ã€‚â€”â€”ä¸ºå­¦é¡»æ€æ‰€ä»¥è¶…å‡¡å…¥åœ£ã€‚" },
            { word: "æ˜å¾·", desc: "æ˜æ˜å¾·äºå¤©ä¸‹ï¼Œè‡ªæ˜­å…¶æ˜å¾·ã€‚â€”â€”æ˜å¾·è€…ï¼Œäººä¹‹æ‰€å¾—ä¹å¤©ï¼Œè‡³æ˜è€Œä¸æ˜§è€…ä¹Ÿã€‚" },
            { word: "å¤©æ¸¸", desc: "å¿ƒä¸å¤©æ¸¸ï¼Œä¸Šä¸‹åŒæµï¼Œæ˜¯ä¸ºå¤©äººåˆä¸€ã€‚â€”â€”å¿ƒå¹¿å¤§å¦‚å¤©åœ°ï¼Œè™šæ˜å¦‚æ—¥æœˆã€‚" },
            { word: "æ³‰æ¶Œ", desc: "é»˜è¯†å¿ƒé€šï¼Œè§¦å¤„é€¢æºï¼Œå¦‚æ³‰ä¹‹æ¶Œã€‚â€”â€”æ½œå¿ƒç§¯è™‘ï¼Œé»˜è¯†å¿ƒé€šï¼Œåˆ™è‡ªç„¶æœ‰æ´’ç„¶å¤„ã€‚" },
        ]
    };


    // --- è°œé¢˜æ¸²æŸ“å‡½æ•° ---

    /**
     * ç‚¹ä½1ï¼šç°ªèŠ±ç¥ˆç¦ä»ªå¼
     * å·²ä¿®æ”¹ï¼šå°†éšæœºæŠ½ç­¾æ”¹ä¸ºç©å®¶é€‰æ‹©ç­¾æ–‡ã€‚
     */
    function renderZanhuaRitual() {
        const interactionArea = document.getElementById('interaction-area');
        const scene = scenes['dot1_ritual'];
        let { step, stepsComplete, labels } = scene.state;

        const ritualSteps = labels.map((label, index) => {
            const isCurrent = index === step;
            const isCompleted = stepsComplete[index];
            const iconMap = ["ğŸ’§", "ğŸ”¥", "ğŸŒ¸", "ğŸ™"];
            
            return `
                <button id="ritual-btn-${index}" 
                        class="flex flex-col items-center justify-center p-4 m-2 rounded-xl transition duration-300 transform 
                        ${isCompleted ? 'bg-green-100/50 text-green-700 opacity-70 cursor-default' : isCurrent ? 'bg-accent-red/20 hover:bg-accent-red/30 shadow-md' : 'bg-paper/50 hover:bg-wood-dark/10 shadow-sm'} 
                        ${index > step ? 'opacity-40 cursor-default' : ''}" 
                        onclick="handleRitualStep(${index})"
                        ${isCompleted || index > step ? 'disabled' : ''}>
                    <span class="text-4xl">${iconMap[index]}</span>
                    <span class="mt-2 text-ink text-sm">${label}</span>
                </button>
            `;
        }).join('');

        // æŒ‰é’®æ”¹ä¸ºâ€œå®Œæˆä»ªå¼â€
        const drawButton = `
            <button id="draw-sign-btn" class="gufu-btn gufu-btn-primary mt-6" onclick="showSignOptions()" ${stepsComplete.every(s => s) ? '' : 'disabled'}>
                å®Œæˆä»ªå¼ï¼Œé€‰æ‹©ç­¾ç­’
            </button>
        `;

        interactionArea.innerHTML = `
            <div class="flex justify-center flex-wrap" id="ritual-buttons-container">${ritualSteps}</div>
            <div class="text-center mt-6" id="draw-sign-container">${drawButton}</div>
            <div id="sign-result" class="mt-6 text-center font-display text-lg text-green-700"></div>
        `;
        
        // å¦‚æœä»ªå¼å·²å®Œæˆï¼Œåˆ™ç›´æ¥æ˜¾ç¤ºç­¾æ–‡é€‰é¡¹ï¼Œè¦†ç›–æŒ‰é’®ã€‚
        if (stepsComplete.every(s => s)) {
            showSignOptions(true);
        }
    }

    // å¤„ç†ä»ªå¼æ­¥éª¤ç‚¹å‡» (åªä¿®æ”¹æœ€åçš„æç¤º)
    window.handleRitualStep = (index) => {
        const scene = scenes['dot1_ritual'];
        let { step, stepsComplete, labels } = scene.state;
        const interactionArea = document.getElementById('interaction-area');

        if (index === step) {
            stepsComplete[index] = true;
            
            if (index < labels.length - 1) {
                step++;
                scene.state.step = step;
                // æç¤ºä¸‹ä¸€ä¸ªæ­¥éª¤
                const nextStepLabel = labels[step];
                interactionArea.querySelector('#sign-result').innerHTML = `<p class="text-accent-red">âœ… ${labels[index]} ç¤¼æˆï¼<br>è¯·è¿›è¡Œä¸‹ä¸€æ­¥ï¼šã€${nextStepLabel}ã€‘</p>`;
                
                // å¦‚æœæ˜¯æ–æ‹œï¼Œåˆ™ç«‹å³å®Œæˆ
                if (step === labels.length - 1) {
                     stepsComplete[step] = true;
                     scene.state.stepsComplete = stepsComplete;
                     interactionArea.querySelector('#draw-sign-btn').disabled = false;
                     interactionArea.querySelector('#sign-result').innerHTML = `<p class="text-green-700">ğŸ‰ æ–æ‹œå…ˆå¸ˆï¼Œä»ªè½¨å¤åŸï¼è¯·é€‰æ‹©ç­¾ç­’ã€‚</p>`;
                }
            } else {
                 // æœ€åä¸€ä¸ªæ­¥éª¤å®Œæˆ
                 scene.state.stepsComplete = stepsComplete;
                 interactionArea.querySelector('#sign-result').innerHTML = `<p class="text-green-700">ğŸ‰ æ–æ‹œå…ˆå¸ˆï¼Œä»ªè½¨å¤åŸï¼è¯·é€‰æ‹©ç­¾ç­’ã€‚</p>`;
            }
            
            renderZanhuaRitual();
        } else {
            interactionArea.querySelector('#sign-result').innerHTML = '<p class="text-red-600">âŒ é¡ºåºæœ‰è¯¯ï¼è¯·ä¾å¾ªä»ªè½¨æ­¥éª¤ã€‚</p>';
        }
    };
    
    // æ–°å¢å‡½æ•°ï¼šæ˜¾ç¤ºä¸‰ä¸ªç­¾æ–‡é€‰é¡¹
    window.showSignOptions = (isInitialRender = false) => {
        const interactionArea = document.getElementById('interaction-area');
        
        // ç­¾æ–‡é€‰é¡¹
        const signs = [
            { name: "å‹¤å­¦ç­¾", text: "è¯»ä¹¦ä¹‹æ³•ï¼Œåœ¨å¾ªåºè€Œæ¸è¿›ï¼Œç†Ÿè¯»è€Œç²¾æ€ã€‚â€”â€”æ„¿å°”æŒä¹‹ä»¥æ’ï¼Œç»ˆæœ‰æ‰€æˆã€‚", color: 'bg-blue-100/50 text-blue-700' },
            { name: "é™å¿ƒç­¾", text: "å¿ƒä¸å®šï¼Œæ•…è§ç†ä¸å¾—ã€‚ä»Šè€Œåï¼Œæ±å½“é™åæ”¶å¿ƒï¼Œæ¶µå…»æœ¬åŸã€‚", color: 'bg-purple-100/50 text-purple-700' },
            { name: "å¼˜å¿—ç­¾", text: "ç«‹å¿—ä¸åšï¼Œç»ˆä¸æµäº‹ã€‚â€”â€”æ„¿å°”èƒ¸æ€€å¤§å¿—ï¼Œæ ¼ç‰©ç©·ç†ã€‚", color: 'bg-yellow-100/50 text-yellow-700' }
        ];

        const optionsHtml = signs.map((sign, index) => `
            <button class="flex-1 gufu-btn flex-col items-center p-4 m-2 text-base ${sign.color}" 
                    onclick="selectSign(${index}, '${sign.name}', '${sign.text.replace(/'/g, "\\'")}')">
                <span class="text-xl font-display">${sign.name}</span>
                <span class="text-xs opacity-80 mt-1">ï¼ˆç‚¹å‡»é€‰æ‹©æ­¤ç­¾ï¼‰</span>
            </button>
        `).join('');
        
        // å¦‚æœæ˜¯é€šè¿‡ç‚¹å‡»æŒ‰é’®è¿›å…¥ï¼Œå…ˆæ¸…ç©ºæŒ‰é’®
        if (!isInitialRender) {
             document.getElementById('draw-sign-container').innerHTML = ''; 
        }

        // æ’å…¥é€‰æ‹©åŒº
        let signOptionsArea = document.getElementById('sign-options-area');
        if (!signOptionsArea) {
             signOptionsArea = document.createElement('div');
             signOptionsArea.id = 'sign-options-area';
             signOptionsArea.className = 'mt-6 p-4 bg-wood-dark/10 rounded-lg shadow-inner';
             interactionArea.appendChild(signOptionsArea);
        }
        
        signOptionsArea.innerHTML = `
            <p class="text-xl font-display text-accent-red mb-4 text-center">ğŸ“œ è¯·é€‰æ‹©ç­¾ç­’ï¼Œå¾—è·è®­è¯«</p>
            <div class="flex justify-center flex-wrap">${optionsHtml}</div>
            <div id="selected-sign-display" class="mt-4 text-center"></div>
        `;
    }

    // æ–°å¢å‡½æ•°ï¼šç©å®¶é€‰æ‹©ç­¾æ–‡
    window.selectSign = (index, name, text) => {
        const signOptionsArea = document.getElementById('sign-options-area');
        const selectedSignDisplay = document.getElementById('selected-sign-display');
        
        // ç¦ç”¨æ‰€æœ‰é€‰æ‹©æŒ‰é’®
        document.querySelectorAll('#sign-options-area button').forEach(btn => btn.disabled = true);

        // æ˜¾ç¤ºç»“æœ
        selectedSignDisplay.innerHTML = `
            <div class="p-6 bg-green-100/50 rounded-lg shadow-inner mt-4">
                <p class="text-xl font-display text-accent-red mb-4">ğŸ‰ æ­å¾—ã€${name}ã€‘ï¼</p>
                <p class="text-ink text-lg">${text}</p>
            </div>
        `;

        // æ˜¾ç¤ºä¸‹ä¸€æ­¥æŒ‰é’®
        const sceneNav = document.getElementById('scene-nav');
        sceneNav.innerHTML = `<button class="gufu-btn gufu-btn-primary" onclick="setNextScene('dot2_jigsaw')">è¿›å…¥ç‚¹ä½äºŒ (æ‹¼å›¾)</button>`;
    }

    /**
     * ç‚¹ä½2ï¼šæ‹¼å›¾å¤åŸé—¨å›¾ (ç®€åŒ–ä¸ºç‚¹å‡»å®Œæˆ)
     */
    function renderJigsawAndLock() {
        const interactionArea = document.getElementById('interaction-area');
        interactionArea.innerHTML = `
            <div id="jigsaw-area" class="p-6 bg-wood-dark/10 rounded-lg text-center">
                <p class="text-lg mb-4 text-ink"><strong>ä»»åŠ¡ï¼š</strong>è¯·å¤åŸè¢«å‰²ç ´çš„ã€Šå…´è´¤ä¹¦é™¢é—¨å›¾ã€‹ã€‚</p>
                <div class="inline-block p-4 bg-paper/70 rounded-md border border-ink/20">
                    <img src="https://placehold.co/300x150/f0f0f0/333333?text=é—¨å›¾ç¢ç‰‡" alt="[å…´è´¤ä¹¦é™¢é—¨å›¾ç¢ç‰‡]" class="rounded">
                </div>
            </div>
            <div id="lock-result" class="mt-6 text-center">
                <button class="gufu-btn gufu-btn-primary" onclick="completeJigsaw()">
                    æˆ‘å·²æ‹¼å¥½å¹¶å‘ç°èƒŒé¢çº¿ç´¢
                </button>
            </div>
        `;
    }

    // å®Œæˆæ‹¼å›¾
    window.completeJigsaw = () => {
        const interactionArea = document.getElementById('interaction-area');
        interactionArea.innerHTML = `
            <div class="p-6 bg-green-100/50 rounded-lg text-center">
                <p class="text-xl font-display text-green-700 mb-4">æ‹¼å›¾å®Œæˆï¼</p>
                <p class="text-2xl font-display text-ink">â€œæ ¼ç‰©è‡´çŸ¥ï¼Œè¯šæ„æ­£å¿ƒâ€</p>
                <p class="text-lg mt-4 text-ink/70">ä½ çŒ›ç„¶æƒ³èµ·æœ±ç†¹è®²æ˜“ç»æ—¶è¯´â€œå¤§è¡ä¹‹æ•°äº”åï¼Œå…¶ç”¨å››åæœ‰ä¹â€ï¼Œäºæ˜¯è½»è§¦æœ€ä¸­å¤®é‚£é¢—æ˜Ÿâ€”â€”é”ï¼Œåº”å£°è€Œå¼€ã€‚</p>
            </div>
        `;
        // æ˜¾ç¤ºä¸‹ä¸€æ­¥æŒ‰é’®
        const sceneNav = document.getElementById('scene-nav');
        sceneNav.innerHTML = `<button class="gufu-btn gufu-btn-primary" onclick="setNextScene('dot4_intro')">è¿›å…¥è—ä¹¦é˜</button>`;
    };

    /**
     * ç‚¹ä½4ï¼šæˆäººç¤¼ä»ªå¼
     */
    function renderCoronationRitual() {
        const interactionArea = document.getElementById('interaction-area');
        const scene = scenes['dot4_coronation'];

        if (!scene.state.identity) {
            // é€‰æ‹©èº«ä»½é˜¶æ®µ
            interactionArea.innerHTML = `
                <p class="text-lg mb-4"><strong>é€‰æ‹©èº«ä»½ï¼š</strong></p>
                <div class="flex justify-center space-x-6">
                    <button class="gufu-btn flex-1" onclick="selectIdentity('male')">å† ç¤¼ (ç”·å­æˆå¹´ç¤¼)</button>
                    <button class="gufu-btn flex-1" onclick="selectIdentity('female')">ç¬„ç¤¼ (å¥³å­æˆå¹´ç¤¼)</button>
                </div>
            `;
        } else if (!scene.state.ceremonyDone) {
            // ä¸‰åŠ ä¹‹ç¤¼æ’åºé˜¶æ®µ
            const identity = scene.state.identity;
            
            // å®šä¹‰å®Œæ•´çš„æ­¥éª¤ï¼Œå¹¶ç¡®ä¿åœ¨ selectIdentity æ—¶å·²ç»æ‰“ä¹±å¹¶åˆå§‹åŒ–äº† completed å±æ€§
            if (scene.state.sequence.length === 0) {
                 window.selectIdentity(identity); // ç¡®ä¿åˆå§‹åŒ–
                 return;
            }

            const currentOrder = scene.state.sequence;
            const stepLabels = ["åˆåŠ ", "äºŒåŠ ", "ä¸‰åŠ "];
            const currentStepLabel = stepLabels[scene.state.currentStep]; // ä¿®æ­£åçš„ label è·å–

            const sequenceDisplay = currentOrder.map((step, index) => {
                const isCurrentExpected = step.order === (scene.state.currentStep + 1); // æœŸå¾…çš„ä¸‹ä¸€ä¸ªæ­¥éª¤ order (1, 2, or 3)
                const isCompleted = step.completed;

                return `
                    <div id="step-item-${index}" class="p-4 bg-paper/70 rounded-lg shadow-md flex items-center justify-between transition duration-200 
                        ${isCompleted ? 'bg-green-100/50 opacity-70 line-through' : isCurrentExpected ? 'border-2 border-accent-red' : ''}
                    ">
                        <span>${step.label}</span>
                        <button class="gufu-btn text-sm px-3 py-1" onclick="selectStep(${step.order})" ${isCompleted || scene.state.ceremonyDone ? 'disabled' : ''}>
                            ${isCompleted ? 'âœ… å·²åŠ ' : 'é€‰æ‹©'}
                        </button>
                    </div>
                `;
            }).join('');

            interactionArea.innerHTML = `
                <p class="text-xl font-display text-accent-red mb-4">ã€${identity === 'male' ? 'å† ç¤¼' : 'ç¬„ç¤¼'}ã€‘ä¸‰åŠ ä¹‹ç¤¼</p>
                <p class="text-lg mb-4 text-ink"><strong>ä»»åŠ¡ï¼š</strong>è¯·æŒ‰â€œåˆåŠ  &rarr; äºŒåŠ  &rarr; ä¸‰åŠ â€çš„æ­£ç¡®é¡ºåºç‚¹å‡»ã€‚å½“å‰åº”é€‰æ‹©ï¼š<span class="text-accent-red font-bold">${currentStepLabel || 'åˆåŠ '}</span></p>
                <div id="sequence-list" class="space-y-3">${sequenceDisplay}</div>
                <div id="coronation-message" class="mt-6 text-center text-red-600"></div>
            `;
        } else {
             // èµå­—é˜¶æ®µ: ç©å®¶æœªé€‰æ‹©å­—æ—¶ï¼Œæ˜¾ç¤ºç­¾ç­’
            if (!scene.state.wordChosen) {
                 const signBoxes = Object.keys(wordOptions).map(cat => `
                    <div class="p-4 bg-wood-dark/10 rounded-lg cursor-pointer hover:bg-wood-dark/20 transition duration-150" onclick="showWordOptions('${cat}')">
                        <p class="text-lg font-display text-accent-red">${cat}</p>
                        <p class="text-sm text-ink/70">ï¼ˆç‚¹å‡»æŸ¥çœ‹èµå­—ï¼‰</p>
                    </div>
                `).join('');

                interactionArea.innerHTML = `
                    <p class="text-xl font-display text-accent-red mb-4">ç¤¼æˆï¼è¯·é€‰æ‹©ç­¾ç­’ï¼Œè·èµæˆäººå­—ã€‚</p>
                    <div id="category-selection" class="grid grid-cols-2 gap-4 text-center">${signBoxes}</div>
                    <div id="word-options-area" class="mt-6"></div>
                `;
            } else {
                // èµå­—å·²é€‰å®šï¼Œæ˜¾ç¤ºç»“æœå’Œä¸‹ä¸€æ­¥æŒ‰é’®
                const chosen = scene.state.wordChosen;
                interactionArea.innerHTML = `
                    <div class="text-center p-6 bg-green-100/50 rounded-lg shadow-inner">
                        <p class="text-xl font-display text-accent-red mb-2">ğŸ æ­è·èµå­—</p>
                        <p class="text-5xl font-display text-wood-dark mb-4">${chosen.word}</p>
                        <p class="text-lg font-display text-ink mb-4">æœ±å­è®­ï¼š</p>
                        <p class="text-base text-ink/80">${chosen.desc}</p>
                    </div>
                `;
                // æ˜¾ç¤ºä¸‹ä¸€æ­¥æŒ‰é’®
                const sceneNav = document.getElementById('scene-nav');
                sceneNav.innerHTML = `<button class="gufu-btn gufu-btn-primary" onclick="setNextScene('dot5_intro')">ç»§ç»­ (å‘ç°è–„ç»¢çº¿ç´¢)</button>`;
            }
        }
    }

    // æ–°å¢å‡½æ•°ï¼šç‚¹å‡»ç±»åˆ«åå±•ç¤ºæ‰€æœ‰å¯é€‰çš„èµå­—å’Œè§£é‡Š
    window.showWordOptions = (category) => {
        const wordList = wordOptions[category];
        const wordOptionsArea = document.getElementById('word-options-area');
        const selectionHtml = wordList.map(item => `
            <div class="p-3 bg-paper/70 rounded-lg shadow-md hover:bg-wood-dark/10 transition duration-150 cursor-pointer" onclick="chooseFinalWord('${item.word}', '${item.desc.replace(/'/g, "\\'")}')">
                <p class="text-2xl font-display text-accent-red">${item.word}</p>
                <p class="text-sm text-ink/70 mt-1">${item.desc.split('â€”â€”')[0]}...</p>
            </div>
        `).join('');

        wordOptionsArea.innerHTML = `
            <h3 class="text-lg font-display text-ink mb-3 border-b border-ink/20 pb-1">ã€${category}ã€‘å¯é€‰èµå­—ï¼ˆç‚¹å‡»é€‰æ‹©ï¼‰</h3>
            <div class="grid grid-cols-2 gap-3">${selectionHtml}</div>
        `;
        
        // ç¦ç”¨ç­¾ç­’ç‚¹å‡»
        document.getElementById('category-selection').classList.add('opacity-50');
        document.querySelectorAll('#category-selection > div').forEach(el => el.onclick = null);
    }
    
    // æ–°å¢å‡½æ•°ï¼šç©å®¶é€‰æ‹©æœ€ç»ˆçš„èµå­—
    window.chooseFinalWord = (word, desc) => {
        const scene = scenes['dot4_coronation'];
        scene.state.wordChosen = { word, desc };
        renderCoronationRitual(); // é‡æ–°æ¸²æŸ“åˆ°ç»“æœé¡µé¢
    }

    // æ´—ç‰Œå‡½æ•°
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    window.selectIdentity = (identity) => {
        const ceremonySteps = identity === 'male' ? 
            [{ label: "åˆåŠ : ç¼å¸ƒå† ", order: 1, completed: false }, { label: "äºŒåŠ : çš®å¼", order: 2, completed: false }, { label: "ä¸‰åŠ : çˆµå¼", order: 3, completed: false }] :
            [{ label: "åˆåŠ : å‘ç°ª", order: 1, completed: false }, { label: "äºŒåŠ : å‘é’—", order: 2, completed: false }, { label: "ä¸‰åŠ : é’—å† ", order: 3, completed: false }];

        scenes['dot4_coronation'].state.identity = identity;
        scenes['dot4_coronation'].state.sequence = shuffleArray(ceremonySteps);
        scenes['dot4_coronation'].state.currentStep = 0;
        scenes['dot4_coronation'].state.ceremonyDone = false;
        scenes['dot4_coronation'].state.wordChosen = null; // é‡ç½®èµå­—é€‰æ‹©
        renderCoronationRitual();
    };

    window.selectStep = (selectedOrder) => {
        const scene = scenes['dot4_coronation'];
        const messageBox = document.getElementById('coronation-message');
        const expectedOrder = scene.state.currentStep + 1; // 1, 2, or 3

        if (selectedOrder === expectedOrder) {
            
            // 1. æ ‡è®°ä¸ºå·²å®Œæˆ
            const selectedItem = scene.state.sequence.find(s => s.order === selectedOrder);
            if (selectedItem) {
                selectedItem.completed = true;
            }

            scene.state.currentStep++; // å‰è¿›åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µ
            
            // BUG FIX: ä¿®æ­£äº†åˆ¤æ–­é€»è¾‘ã€‚å½“ currentStep è¾¾åˆ° 3 æ—¶ï¼Œè¡¨ç¤ºâ€œä¸‰åŠ â€å·²å®Œæˆã€‚
            if (scene.state.currentStep >= 3) {
                // ä»ªå¼å®Œæˆ
                scene.state.ceremonyDone = true;
                messageBox.innerHTML = '<span class="text-green-700">ğŸ‰ æˆäººä»ªè½¨å®Œæ•´å¤åŸï¼</span>';
            } else {
                // å‡†å¤‡ä¸‹ä¸€ä¸ªæ­¥éª¤çš„æç¤º
                const currentStageLabel = ["åˆåŠ ", "äºŒåŠ ", "ä¸‰åŠ "][selectedOrder - 1];
                messageBox.innerHTML = `<span class="text-green-700">âœ… ${currentStageLabel} ç¤¼æˆï¼è¯·é€‰æ‹©ã€${["åˆåŠ ", "äºŒåŠ ", "ä¸‰åŠ "][scene.state.currentStep]}ã€‘ã€‚</span>`;
            }
            
            renderCoronationRitual(); // é‡æ–°æ¸²æŸ“ä»¥åæ˜ æ–°çŠ¶æ€
            
        } else {
            messageBox.innerHTML = '<span class="text-red-600">âŒ é¡ºåºæœ‰è¯¯ï¼è¯·ä¾å¾ªâ€œåˆåŠ ã€äºŒåŠ ã€ä¸‰åŠ â€ä¹‹åºã€‚æ‚¨åº”é€‰æ‹©ã€' + ["åˆåŠ ", "äºŒåŠ ", "ä¸‰åŠ "][scene.state.currentStep] + 'ã€‘ã€‚</span>';
        }
    };
    
    window.chooseWord = (category, words) => {
        // æ­¤å‡½æ•°ä¸å†ä½¿ç”¨ï¼ŒåŠŸèƒ½è¢« showWordOptions/chooseFinalWord å–ä»£
    };
    
    /**
     * ç‚¹ä½5ï¼šåˆ˜æ°å®¶ç¥ è€ƒéªŒ
     */
    function renderLiuFamilyTest() {
        const interactionArea = document.getElementById('interaction-area');
        const options = [
            { name: "åˆ˜éŸå…¬", info: "æŠ—é‡‘æ®‰å›½çš„å¿ çƒˆä¹‹å£«" },
            { name: "åˆ˜å­ç¾½å…¬", info: "åº‡æŠ¤ç†å­¦çš„åšå®ç ¥æŸ±" }, // Correct
            { name: "åˆ˜å­ç¿šå…¬", info: "åŠ›æ–¥è®®å’Œçš„åˆšæ­£ä¹‹è‡£" },
            { name: "åˆ˜ç™å…¬", info: "æ‰¿ç»­æ–‡è„‰çš„å„’å­¦å¤§å®¶" }
        ];

        const optionsHtml = options.map((opt, index) => `
            <button class="gufu-btn flex-1 flex-col items-center p-4 m-2 text-sm" 
                    onclick="checkLiuTest('${opt.name}', this)">
                <span class="text-lg">${opt.name}</span>
                <span class="text-xs opacity-80 mt-1">(${opt.info})</span>
            </button>
        `).join('');

        interactionArea.innerHTML = `
            <p class="text-lg mb-4"><strong>ä»»åŠ¡ï¼š</strong>è¯·é€‰æ‹©å—æœ±æ¾å…¬æ‰˜å­¤ï¼Œå¹¶åœ¨ç´«é˜³æºªç•”ä¸ºæœ±ç†¹ç­‘å®¤æˆç»çš„æ©å¸ˆ/ä¹‰çˆ¶ã€‚</p>
            <div id="liu-options" class="flex flex-wrap justify-center">${optionsHtml}</div>
            <div id="liu-test-result" class="mt-6 text-center"></div>
        `;
    }

    // æ£€æŸ¥åˆ˜æ°å®¶ç¥ ç­”æ¡ˆ
    window.checkLiuTest = (selection, button) => {
        const resultBox = document.getElementById('liu-test-result');
        document.querySelectorAll('#liu-options button').forEach(btn => btn.disabled = true);

        if (selection === "åˆ˜å­ç¾½å…¬") {
            resultBox.innerHTML = `
                <div class="p-4 bg-green-100/50 rounded-lg text-green-700">
                    <p class="text-xl font-display mb-2">âœ… æ­£ç¡®ï¼</p>
                    <p>â€œå¿…æ˜¯å­ç¾½å…¬ï¼ä»–å—æ‰˜å­¤é‡ä»»ï¼Œç­‘å®¤æˆç»ï¼Œä¹ƒæ˜¯å…ˆç”Ÿä¹‰çˆ¶ã€‚åˆ˜æ°ä¸€é—¨ â€˜ä¸‰å¿ ä¸€æ–‡â€™ï¼Œå¿ ä¹‰ä¼ å®¶ï¼Œæ–¹æ‰æŠ¤å¾—ç†å­¦è–ªç«ç›¸ä¼ ï¼â€</p>
                </div>
            `;
            // å¯ç”¨ä¸‹ä¸€æ­¥
            const sceneNav = document.getElementById('scene-nav');
            sceneNav.innerHTML = `<button class="gufu-btn gufu-btn-primary" onclick="setNextScene('dot6_intro')">å‰å¾€ç¤¾ä»“</button>`;
        } else {
            resultBox.innerHTML = `
                <div class="p-4 bg-red-100/50 rounded-lg text-red-700">
                    <p class="text-xl font-display mb-2">âŒ è°¬çŸ£ï¼</p>
                    <p>è¯·ä»”ç»†å›æƒ³â€œç­‘å®¤ç´«é˜³â€ä¹‹å…¸æ•…ï¼Œå”¯æœ‰ä»–å—æ‰˜å­¤é‡ä»»ã€‚è¯·é‡æ–°æ€è€ƒã€‚</p>
                </div>
            `;
            document.querySelectorAll('#liu-options button').forEach(btn => btn.disabled = false); // å…è®¸é‡è¯•
            button.classList.add('opacity-50'); // æ ‡è®°é”™è¯¯é€‰é¡¹
        }
    };
    
    /**
     * ç‚¹ä½6ï¼šç¤¾ä»“è£å†³
     */
    function renderShecangJudgement() {
        const interactionArea = document.getElementById('interaction-area');
        const scene = scenes['dot6_judgement'];
        let { currentCase, cases } = scene.state;

        if (currentCase >= cases.length) {
            interactionArea.innerHTML = `
                <div class="p-6 bg-green-100/50 rounded-lg text-green-700">
                    <p class="text-xl font-display mb-4">ğŸ‰ ä¸‰æ¡ˆè£å†³å…¬æ­£ï¼</p>
                    <p>ä½ å…¬æ­£çš„è£å†³ï¼Œè®©è€å†œçƒ­æ³ªç›ˆçœ¶ã€‚ä»–é¢¤é¢¤å·å·åœ°å‘Šè¯‰ä½ ï¼šâ€œé‚£å¸®å¤©æ€çš„ï¼Œæ¬æ¥äº†å‡ ä¸ªæ–°ç²®æ–—ï¼Œå°±æ”¾åœ¨æœ€é‡Œé¢é‚£ä¸ªè§’è½ã€‚äº¥æ—¶ä¸‰åˆ»äº•ç•”ä¼šâ€¦â€</p>
                </div>
            `;
            const sceneNav = document.getElementById('scene-nav');
            sceneNav.innerHTML = `<button class="gufu-btn gufu-btn-primary" onclick="setNextScene('dot13_intro')">å‰å¾€äº”è´¤äº•</button>`;
            return;
        }

        const current = cases[currentCase];

        // ç¤¾ä»“æ‰‹å†Œè§„åˆ™
        const rulesHtml = `
            <div class="p-3 mb-4 bg-wood-dark/10 rounded-lg border-l-4 border-accent-red/70">
                <p class="text-lg font-display text-accent-red mb-2">ã€Šç¤¾ä»“æ‰‹å†Œã€‹è§„å®š (ä»ä¹‰ä¸ºæœ¬)</p>
                <ul class="list-disc list-inside text-ink text-sm space-y-1">
                    <li><strong>è’å¹´èµˆæµä¸ºæœ¬ï¼Œæ¯ç±³çš†å…ã€‚</strong></li>
                    <li><strong>ä¸°å¹´å–æ¯æœ‰åº¦ï¼Œä¸ä¸ºç›˜å‰¥</strong> (åˆ©æ¯ä¸å¾—è¶…è¿‡ä¸€æˆäº”)ã€‚</li>
                    <li><strong>é³å¯¡å­¤ç‹¬è€…å…è€—</strong>ï¼Œæ›´åº”é…Œæƒ…å»¶æœŸæˆ–å‡å…æœ¬é‡‘ã€‚</li>
                </ul>
            </div>
        `;

        interactionArea.innerHTML = `
            ${rulesHtml}
            <p class="text-lg mb-4"><strong>æ¡ˆä»¶ ${currentCase + 1} / ${cases.length}ï¼š</strong></p>
            <div class="p-4 bg-paper/70 rounded-lg shadow-md mb-6">
                <p class="text-ink">${current.statement}</p>
                <p class="text-sm mt-2 text-ink/70">å€¼å®ˆå¼Ÿå­æ–¹æ¡ˆï¼šã€${current.statement.match(/å€¼å®ˆå¼Ÿå­æ–¹æ¡ˆï¼š(.*?)(ã€‚|\.|$)/)?.[1] || 'ï¼ˆè§æ¡ˆä»¶æè¿°ï¼‰'}ã€‘</p>
            </div>
            
            <div class="flex justify-center space-x-6">
                <button class="gufu-btn flex-1" onclick="checkJudgement('false', '${current.correct}', '${current.rule}')">è£å†³ï¼šâŒ é”™è¯¯</button>
                <button class="gufu-btn flex-1" onclick="checkJudgement('true', '${current.correct}', '${current.rule}')">è£å†³ï¼šâœ… æ­£ç¡®</button>
            </div>
            <div id="judgement-result" class="mt-6 text-center"></div>
        `;
    }
    
    // æ£€æŸ¥ç¤¾ä»“è£å†³ç­”æ¡ˆ
    window.checkJudgement = (playerAnswer, correctAnswer, rule) => {
        const resultBox = document.getElementById('judgement-result');
        const scene = scenes['dot6_judgement'];
        
        document.querySelectorAll('#interaction-area button').forEach(btn => btn.disabled = true);

        // è£å†³æ­£ç¡®é€»è¾‘ï¼šå› ä¸ºæ‰€æœ‰æ¡ˆä¾‹ä¸­ï¼Œå€¼å®ˆå¼Ÿå­çš„æ–¹æ¡ˆéƒ½æ˜¯é”™è¯¯çš„ï¼Œæ‰€ä»¥æ­£ç¡®è£å†³åº”è¯¥æ˜¯â€œé”™è¯¯â€ã€‚
        // å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦æ£€æŸ¥ç©å®¶çš„é€‰æ‹©æ˜¯å¦ä¸é¢„è®¾çš„æ­£ç¡®ç­”æ¡ˆï¼ˆ'false'ï¼‰ä¸€è‡´å³å¯ã€‚
        // NOTE: æˆ‘æ ¹æ®æ‚¨æä¾›çš„æ¡ˆä¾‹å†…å®¹ï¼ˆå€¼å®ˆå¼Ÿå­æ–¹æ¡ˆçš†é”™ï¼‰ï¼Œä¿®æ­£äº†æŒ‰é’®ç‚¹å‡»å’Œåˆ¤æ–­é€»è¾‘ã€‚
        if ((playerAnswer === 'false' && correctAnswer === 'false') || (playerAnswer === 'true' && correctAnswer === 'true')) {
            resultBox.innerHTML = `
                <div class="p-4 bg-green-100/50 rounded-lg text-green-700">
                    <p class="text-xl font-display mb-2">âœ… æ˜æ–­ï¼</p>
                    <p>æœ±ç†¹è™šå½±ï¼šâ€œå–„ï¼ç¤¾ä»“ä¹‹è®¾ï¼Œè´µåœ¨â€˜ä¹‰â€™ã€‚ä½ ç§‰å…¬æ‰§æ³•ï¼Œä¸ä¸ºç§åˆ©æ‰€æƒ‘ã€‚â€</p>
                </div>
            `;
            scene.state.currentCase++;
            setTimeout(renderShecangJudgement, 2000);
        } else {
            resultBox.innerHTML = `
                <div class="p-4 bg-red-100/50 rounded-lg text-red-700">
                    <p class="text-xl font-display mb-2">âŒ é”™åˆ¤ï¼</p>
                    <p>æœ±ç†¹è™šå½±ï¼šâ€œå¤§é”™ç‰¹é”™ï¼ç¤¾ä»“ä¹ƒä»å¿ƒä»æœ¯ï¼Œ${rule}ã€‚è¯·æ ¹æ®æ‰‹å†Œï¼Œé‡æ–°æ€è€ƒæ­¤æ¡ˆã€‚â€</p>
                </div>
            `;
            document.querySelectorAll('#interaction-area button').forEach(btn => btn.disabled = false); // å…è®¸é‡è¯•
        }
    };

    /**
     * ç‚¹ä½13ï¼šäº”å£äº•çš„é’¥åŒ™
     */
    function renderWellQuiz() {
        const interactionArea = document.getElementById('interaction-area');
        const scene = scenes['dot13_quiz'];
        
        const quizHtml = `
            <p class="text-lg mb-6"><strong>é¢˜ç›®ï¼š</strong>èƒ¡æ°å®¶å­¦æºè¿œæµé•¿ï¼Œæœ€ç»ˆç”±è°ç›´æ¥ä¼ æˆäºæœ±ç†¹å…ˆç”Ÿï¼Œæˆä¸ºç†å­¦ä¼ æ‰¿çš„å…³é”®ä¸€ç¯ï¼Ÿ</p>
            <div id="quiz-options" class="space-y-3">
                <button class="gufu-btn w-full text-base py-3" onclick="checkWellQuiz('A', this)">A. èƒ¡å®‰å›½ â†’ èƒ¡å® â†’ æœ±ç†¹</button>
                <button class="gufu-btn w-full text-base py-3" onclick="checkWellQuiz('B', this)">B. èƒ¡å®‰å›½ â†’ èƒ¡å¯… â†’ æœ±ç†¹</button>
                <button class="gufu-btn w-full text-base py-3" onclick="checkWellQuiz('C', this)">C. èƒ¡å®‰å›½ â†’ èƒ¡å®ª â†’ æœ±ç†¹</button>
                <button class="gufu-btn w-full text-base py-3" onclick="checkWellQuiz('D', this)">D. èƒ¡å® â†’ èƒ¡å¯… â†’ æœ±ç†¹</button>
            </div>
            <div id="quiz-result" class="mt-6 text-center"></div>
        `;

        interactionArea.innerHTML = quizHtml;
        
        if (scene.state.answered) {
            document.querySelectorAll('#quiz-options button').forEach(btn => btn.disabled = true);
            const sceneNav = document.getElementById('scene-nav');
            sceneNav.innerHTML = `<button class="gufu-btn gufu-btn-primary" onclick="setNextScene('final_teaching')">æœ€ç»ˆç« ï¼šæœ±å­å··</button>`;
        }
    }

    // æ£€æŸ¥äº”å£äº•è°œé¢˜ç­”æ¡ˆ
    window.checkWellQuiz = (answer, button) => {
        const resultBox = document.getElementById('quiz-result');
        const scene = scenes['dot13_quiz'];
        
        document.querySelectorAll('#quiz-options button').forEach(btn => btn.disabled = true);

        if (answer === 'C') {
            resultBox.innerHTML = `
                <div class="p-4 bg-green-100/50 rounded-lg text-green-700">
                    <p class="text-xl font-display mb-2">âœ… æœºå…³åº”å£°è€Œè§£ï¼</p>
                    <p>èƒ¡å®ªä¹ƒæœ±ç†¹ä¹‹å¸ˆï¼Œèƒ¡æ°å®¶å­¦ç”±æ­¤ä¸€è„‰ç›¸æ‰¿ï¼ã€Šå››ä¹¦ç« æ³¨ã€‹æ‰‹ç¨¿å°±åœ¨ç®±å­é‡Œï¼</p>
                </div>
            `;
            scene.state.answered = true;
            const sceneNav = document.getElementById('scene-nav');
            sceneNav.innerHTML = `<button class="gufu-btn gufu-btn-primary" onclick="setNextScene('final_teaching')">æœ€ç»ˆç« ï¼šæœ±å­å··</button>`;
        } else {
            resultBox.innerHTML = `
                <div class="p-4 bg-red-100/50 rounded-lg text-red-700">
                    <p class="text-xl font-display mb-2">âŒ ç†è„‰æœªé€šï¼</p>
                    <p>çŸ³ç¯å‘å‡ºä½æ²‰çš„å—¡é¸£ã€‚è¯·å†æ€ä¹‹ï¼Œæœ±ç†¹ä¹‹å¸ˆæ˜¯è°ï¼Ÿ</p>
                </div>
            `;
            document.querySelectorAll('#quiz-options button').forEach(btn => btn.disabled = false); // å…è®¸é‡è¯•
            button.classList.add('opacity-50'); // æ ‡è®°é”™è¯¯é€‰é¡¹
        }
    };

    /**
     * ç‚¹ä½14ï¼šç†å¿ƒé—®é“
     */
    function renderFinalTeachings() {
        const interactionArea = document.getElementById('interaction-area');
        const scene = scenes['final_teaching'];
        let { currentQuestion, questions, score } = scene.state;

        if (currentQuestion >= questions.length) {
            interactionArea.innerHTML = `
                <div class="p-6 bg-green-100/50 rounded-lg text-green-700">
                    <p class="text-xl font-display mb-4">ğŸ‰ ç†å¿ƒå·²æ˜ï¼Œå¿§æƒ‘æ¸æ¶ˆï¼</p>
                    <p>æœ±ç†¹èµ è¨€ï¼šâ€œçŸ¥å›°è€Œèƒ½æ±‚è§£ï¼Œå·²æ˜¯å‘å­¦ä¹‹å¿ƒã€‚åˆ‡è®°ï¼ŒåŠŸå¤«åœ¨å¹³æ—¥ï¼Œå¾ªåºæ¸è¿›è€Œå·²ã€‚â€</p>
                </div>
            `;
            const sceneNav = document.getElementById('scene-nav');
            sceneNav.innerHTML = `<button class="gufu-btn gufu-btn-primary" onclick="setNextScene('epilogue')">ç»“æŸæ—…ç¨‹</button>`;
            return;
        }

        const current = questions[currentQuestion];
        const optionsHtml = current.options.map((opt, index) => `
            <button class="gufu-btn w-full text-base py-3" onclick="checkFinalTeaching(${index}, ${current.correctIndex}, '${current.explanation}')">
                ${String.fromCharCode(65 + index)}. ${opt}
            </button>
        `).join('');

        interactionArea.innerHTML = `
            <p class="text-lg mb-4"><strong>é—®å¿ƒç¬¬ ${currentQuestion + 1} æƒ‘ï¼š</strong></p>
            <div class="p-4 bg-wood-dark/10 rounded-lg shadow-inner mb-6">
                <p class="text-ink">${current.prompt}</p>
            </div>
            
            <div id="final-options" class="space-y-3">${optionsHtml}</div>
            <div id="final-result" class="mt-6 text-center"></div>
        `;
    }

    // æ£€æŸ¥ç†å¿ƒé—®é“ç­”æ¡ˆ
    window.checkFinalTeaching = (playerIndex, correctIndex, explanation) => {
        const resultBox = document.getElementById('final-result');
        const scene = scenes['final_teaching'];
        
        document.querySelectorAll('#final-options button').forEach(btn => btn.disabled = true);

        if (playerIndex === correctIndex) {
            resultBox.innerHTML = `
                <div class="p-4 bg-green-100/50 rounded-lg text-green-700">
                    <p class="text-xl font-display mb-2">âœ… å¿ƒç†å¥‘åˆï¼</p>
                    <p>${explanation}</p>
                </div>
            `;
            scene.state.score++;
            scene.state.currentQuestion++;
            setTimeout(renderFinalTeachings, 3000);
        } else {
            resultBox.innerHTML = `
                <div class="p-4 bg-red-100/50 rounded-lg text-red-700">
                    <p class="text-xl font-display mb-2">âŒ ä»æœ‰è¿·æƒ˜ï¼</p>
                    <p>è¯·ä»”ç»†æ€è€ƒå…ˆç”Ÿâ€œäº‹ä¸Šç£¨å¿ƒâ€å’Œâ€œå¿ƒå¦‚è¡£é¢†â€çš„æ•™è¯²ï¼Œå†è¡Œé€‰æ‹©ã€‚</p>
                </div>
            `;
            document.querySelectorAll('#final-options button').forEach(btn => btn.disabled = false); // å…è®¸é‡è¯•
            document.querySelectorAll('#final-options button')[playerIndex].classList.add('opacity-50', 'bg-red-200'); // æ ‡è®°é”™è¯¯é€‰é¡¹
        }
    };


    // --- é¡µé¢åŠ è½½å¯åŠ¨æ¸¸æˆ ---
    window.onload = function() {
        initGame();
    };

</script>

</body>
</html>
